<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>SEENÄHE</title>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <!-- Google Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,300,0,0" />
    <!-- IBM Plex Sans & Mono Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@300;400;600&display=swap" />
    
    <style>
        :root {
            --bg: #000000;
            --text: #FFFFFF;
            --text-secondary: #6B6B6B;
            --accent: #6B6B6B;
        }
        @media (prefers-color-scheme: light) {
            :root {
                --bg: #FFFFFF;
                --text: #000000;
            }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { 
            width: 100%; 
            height: 100%; 
            overflow: hidden;
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        
        /* Onboarding */
        #onboarding {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 9999;
        }
        #onboarding.hidden { display: none; }
        .onboarding-logo {
            width: 200px;
            height: auto;
            margin-bottom: 48px;
        }
        .onboarding-logo path { fill: var(--text); }
        .onboarding-text { font-size: 16px; line-height: 1.6; text-align: center; }
        .onboarding-button {
            background: var(--text);
            color: var(--bg);
            border: none;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 100px;
            cursor: pointer;
            margin-top: 100px;
        }
        #loadingStatus {
            margin-top: 20px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* App Container */
        #app {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: none;
        }
        #app.visible { display: block; }
        
        /* Map */
        #map {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
            background: linear-gradient(135deg, #e8e8e8 0%, #d0d0d0 50%, #e0e0e0 100%);
        }
        @media (prefers-color-scheme: dark) {
            #map {
                background: linear-gradient(135deg, #1a1a1a 0%, #252525 50%, #1f1f1f 100%);
            }
        }
        .leaflet-container { background: transparent !important; }
        .leaflet-marker-pane, .leaflet-overlay-pane, .leaflet-popup-pane { filter: none !important; }
        .leaflet-tile-pane { filter: grayscale(1); }
        @media (prefers-color-scheme: dark) {
            .leaflet-tile-pane { filter: invert(1) grayscale(1) brightness(0.7); }
        }
        
        /* Header - Filter Pills only */
        .header-container {
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            background: linear-gradient(to bottom, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 70%, transparent 100%);
            padding-top: 15px;
            padding-bottom: 20px;
        }
        @media (prefers-color-scheme: light) {
            .header-container { background: linear-gradient(to bottom, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.85) 70%, transparent 100%); }
        }
        
        /* Hide old top-bar elements */
        .top-bar { display: none; }
        .bookmarks-btn { display: none; }
        
        /* Bottom Tabbar - Flat Design */
        .tabbar {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            z-index: 1000;
            background: var(--bg);
            border-top: 1px solid rgba(128,128,128,0.2);
            padding-bottom: env(safe-area-inset-bottom, 0);
            display: flex;
            justify-content: space-around;
            align-items: stretch;
        }
        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 13px 0 15px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
            position: relative;
        }
        .tab-item.active {
            color: var(--text);
        }
        .tab-item .material-symbols-rounded {
            font-size: 24px;
            margin-bottom: 2px;
        }
        .tab-item span:last-child {
            font-size: 10px;
            font-weight: 500;
        }
        .tab-item .badge {
            position: absolute;
            top: 9px;
            right: calc(50% - 20px);
            min-width: 16px;
            height: 16px;
            background: var(--text);
            color: var(--bg);
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }
        .tab-item .badge.hidden { display: none; }
        
        /* View Toggle - centered above tabbar */
        .view-toggle {
            position: absolute;
            bottom: calc(80px + env(safe-area-inset-bottom, 0));
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            display: flex;
            background: rgba(0,0,0,0.9);
            border-radius: 100px;
            padding: 4px;
            gap: 4px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        @media (prefers-color-scheme: light) {
            .view-toggle { background: rgba(255,255,255,0.95); box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        }
        .view-toggle::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 44px;
            height: 44px;
            background: var(--text);
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }
        .view-toggle.list-active::before {
            transform: translateX(48px);
        }
        .toggle-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
            position: relative;
            z-index: 1;
        }
        .toggle-btn.active {
            color: var(--bg);
        }
        .toggle-btn .material-symbols-rounded { font-size: 24px; }
        
        /* Cluster Pills - Fixed Scrolling */
        .cluster-scroll-wrapper {
            width: 100%;
            overflow: visible;
        }
        .cluster-pills { 
            display: flex; 
            flex-wrap: nowrap;
            gap: 8px; 
            padding: 0 16px;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .cluster-pills::-webkit-scrollbar { 
            display: none; 
            width: 0;
            height: 0;
        }
        .cluster-pill {
            flex: 0 0 auto;
            padding: 8px 14px;
            font-size: 13px;
            border: 1px solid #999;
            background: rgba(0,0,0,0.6);
            color: var(--text-secondary);
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        @media (prefers-color-scheme: light) { .cluster-pill { background: rgba(255,255,255,0.8); border-color: #999; } }
        .cluster-pill.active { background: var(--text); color: var(--bg); border-color: var(--text); }
        .cluster-pill .count { 
            color: var(--text-secondary); 
            font-size: 11px;
            margin-left: 2px;
        }
        .cluster-pill.active .count { color: var(--accent); }
        
        /* List View */
        .list-view {
            position: absolute;
            top: 0; left: 0; right: 0; 
            bottom: calc(70px + env(safe-area-inset-bottom, 0));
            background: var(--bg);
            z-index: 999;
            display: none;
            flex-direction: column;
        }
        .list-view.visible { display: flex; }
        
        /* List Date Section Headers - Sticky */
        .list-date-header {
            position: sticky;
            top: 0;
            background: rgba(128,128,128,0.15);
            padding: 10px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            z-index: 10;
        }
        @media (prefers-color-scheme: light) {
            .list-date-header { background: rgba(230,230,230,0.98); }
        }
        @media (prefers-color-scheme: dark) {
            .list-date-header { background: rgba(45,45,45,0.98); }
        }
        
        /* List Header with Sort */
        .list-header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 70px 16px 12px;
            background: var(--bg);
            border-bottom: 1px solid rgba(128,128,128,0.15);
        }
        
        #listContent {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .list-header-title {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .sort-dropdown {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: rgba(128,128,128,0.1);
            border: none;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .sort-dropdown .material-symbols-rounded { font-size: 16px; }
        
        /* Bookmarks View */
        .bookmarks-view {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            z-index: 5000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .bookmarks-view.visible { transform: translateX(0); }
        
        .bookmarks-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 50px 16px 16px 16px;
            border-bottom: 1px solid rgba(128,128,128,0.15);
        }
        .bookmarks-back {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bookmarks-back .material-symbols-rounded { font-size: 24px; }
        .bookmarks-title {
            font-size: 18px;
            font-weight: 600;
        }
        .bookmarks-list {
            overflow-y: auto;
            padding-bottom: 40px;
        }
        .bookmarks-empty {
            text-align: center;
            padding: 60px 24px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Venue Detail View */
        .venue-view {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            z-index: 5500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        .venue-view.visible { transform: translateX(0); }
        
        .venue-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 16px 16px 16px;
            border-bottom: 1px solid rgba(128,128,128,0.15);
        }
        .bookmarks-title.clickable {
            cursor: pointer;
        }
        .venue-content {
            padding: 24px 16px;
        }
        .venue-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .venue-type {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .venue-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 20px;
        }
        
        /* Venue Image Carousel */
        .venue-carousel {
            margin: 0 -16px 24px -16px;
            overflow: hidden;
        }
        .venue-carousel-track {
            display: flex;
            transition: transform 0.3s ease;
        }
        .venue-carousel-slide {
            flex: 0 0 100%;
            padding: 0 16px;
        }
        .venue-carousel-placeholder {
            width: 100%;
            height: 200px;
            background: rgba(128,128,128,0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .venue-carousel-placeholder .material-symbols-rounded {
            font-size: 48px;
            color: rgba(128,128,128,0.3);
        }
        .venue-carousel-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }
        .venue-carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(128,128,128,0.3);
            transition: background 0.3s ease;
        }
        .venue-carousel-dot.active {
            background: var(--text);
        }
        
        .venue-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            margin-top: 24px;
        }
        .venue-info-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(128,128,128,0.1);
        }
        .venue-info-row .material-symbols-rounded {
            font-size: 20px;
            color: var(--text-secondary);
        }
        .venue-info-text {
            font-size: 15px;
        }
        .venue-events-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            margin-top: 32px;
        }
        .venue-events-list {
            margin: 0 -16px;
        }
        
        /* Venue Opening Hours */
        .venue-hours {
            margin-top: 8px;
        }
        .venue-hours-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
        }
        .venue-hours-day {
            font-size: 14px;
            color: var(--text);
        }
        .venue-hours-time {
            font-size: 14px;
            color: var(--text-secondary);
        }
        .venue-hours-closed {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Sort Menu */
        .sort-menu {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--bg);
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 20px 24px 40px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 4000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        }
        .sort-menu.visible { transform: translateY(0); }
        .sort-menu-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-align: center;
        }
        .sort-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: rgba(128,128,128,0.1);
            border: none;
            border-radius: 10px;
            color: var(--text);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            cursor: pointer;
            margin-bottom: 8px;
            width: 100%;
            text-align: left;
        }
        .sort-option.active { background: rgba(128,128,128,0.2); }
        .sort-option .material-symbols-rounded { 
            font-size: 20px; 
            color: var(--text);
            opacity: 0;
        }
        .sort-option.active .material-symbols-rounded { opacity: 1; }
        
        .list-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 26px 16px;
            border-bottom: 1px solid rgba(128,128,128,0.15);
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .list-item:hover { background: rgba(128,128,128,0.08); }
        .list-item:active { background: rgba(128,128,128,0.15); }
        
        .list-date-box {
            width: 56px; 
            height: 71px;
            background: var(--text);
            color: var(--bg);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-family: 'IBM Plex Mono', monospace;
        }
        .list-date-weekday {
            font-size: 9px;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1px;
        }
        .list-date-day {
            font-size: 24px;
            font-weight: 600;
            line-height: 1;
        }
        .list-date-month {
            font-size: 9px;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1px;
        }
        
        .list-content { flex: 1; min-width: 0; }
        .list-title { 
            font-size: 21px; 
            font-weight: 500; 
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .list-venue {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 6px;
        }
        .list-category {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.7;
        }
        .list-category .material-symbols-rounded {
            font-size: 14px;
        }
        .list-time {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 19px;
            font-weight: 300;
            flex-shrink: 0;
            text-align: right;
        }
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .list-category:hover {
            background: rgba(128,128,128,0.35);
        }
        .list-category:active {
            transform: scale(0.96);
        }
        .list-category .material-symbols-rounded {
            font-size: 12px;
        }
        .list-distance {
            text-align: right;
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 2px;
        }
        .list-distance-value {
            font-size: 22px;
            font-weight: 500;
            color: var(--text);
            letter-spacing: -0.02em;
        }
        .list-distance-unit {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: 2px;
        }
        /* Event Count - now under filter pills */
        .event-count {
            display: none;
        }
        .header-event-count {
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 8px 16px 0;
        }
        
        /* Cluster Markers (grouped) */
        .cluster-marker {
            border-radius: 50%;
            background: #000;
            border: 2px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            color: #fff;
            font-size: 13px;
            font-weight: 500;
        }
        @media (prefers-color-scheme: light) { 
            .cluster-marker { background: #fff; border-color: #000; color: #000; } 
        }
        
        /* Venue Cluster Markers (square) */
        .venue-cluster-marker {
            border-radius: 4px;
            background: #000;
            border: 2px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            color: #fff;
            font-size: 13px;
            font-weight: 500;
        }
        @media (prefers-color-scheme: light) { 
            .venue-cluster-marker { background: #fff; border-color: #000; color: #000; } 
        }
        
        /* Single Event Markers */
        .event-marker {
            border-radius: 50%;
            background: #000;
            border: 2px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            color: #fff;
        }
        @media (prefers-color-scheme: light) { 
            .event-marker { background: #fff; border-color: #000; color: #000; } 
        }
        
        /* Venue Markers (Square) */
        .venue-marker {
            border-radius: 4px;
            background: #000;
            border: 2px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            color: #fff;
        }
        @media (prefers-color-scheme: light) { 
            .venue-marker { background: #fff; border-color: #000; color: #000; } 
        }
        .venue-marker.active {
            box-shadow: 0 0 0 4px #ff6b35, 0 2px 12px rgba(255,107,53,0.5) !important;
        }
        
        /* Theater markers - inverted and 125% larger */
        .event-marker.theater {
            background: #000 !important;
            border-color: #fff !important;
            color: #fff !important;
            transform: scale(1.25);
        }
        @media (prefers-color-scheme: light) { 
            .event-marker.theater { 
                background: #000 !important; 
                border-color: #fff !important; 
                color: #fff !important; 
            } 
        }
        
        /* User Marker */
        .user-marker {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.4), 0 2px 8px rgba(0,0,0,0.3);
            animation: userPulse 2.5s ease-in-out infinite;
        }
        @keyframes userPulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 2px rgba(59,130,246,0.4), 0 2px 8px rgba(0,0,0,0.3);
            }
            50% { 
                transform: scale(1.15); 
                box-shadow: 0 0 0 6px rgba(59,130,246,0.2), 0 0 20px rgba(59,130,246,0.3), 0 2px 12px rgba(0,0,0,0.35);
            }
        }
        
        /* Backdrop */
        .backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
        }
        .backdrop.visible { display: block; }
        
        /* Active Event Marker - Orange highlight */
        .event-marker.active {
            box-shadow: 0 0 0 4px #ff6b35, 0 2px 12px rgba(255,107,53,0.5) !important;
        }
        
        /* Event Sheet - Floating */
        .event-sheet {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: var(--bg);
            border-radius: 20px;
            padding: 16px 20px 24px;
            transform: translateY(calc(100% + 20px));
            transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            z-index: 3000;
            box-shadow: 0 4px 40px rgba(0,0,0,0.25);
            max-height: 45vh;
            overflow-y: auto;
            touch-action: pan-x;
        }
        .event-sheet.visible { transform: translateY(0); }
        .event-sheet.swiping {
            transition: none;
        }
        .event-sheet.swipe-left {
            animation: swipeOutLeft 0.3s ease forwards;
        }
        .event-sheet.swipe-right {
            animation: swipeOutRight 0.3s ease forwards;
        }
        @keyframes swipeOutLeft {
            to { transform: translateX(-120%); opacity: 0; }
        }
        @keyframes swipeOutRight {
            to { transform: translateX(120%); opacity: 0; }
        }
        
        /* Swipe indicator (hidden for now) */
        .swipe-indicator {
            display: none;
            justify-content: center;
            gap: 6px;
            margin-top: 12px;
        }
        .swipe-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
        }
        .swipe-dot.active {
            background: var(--text);
        }
        
        .sheet-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .sheet-top .event-category {
            margin-bottom: 0;
        }
        .sheet-top-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sheet-action-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(128,128,128,0.15);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.15s ease;
        }
        .sheet-action-btn:hover { background: rgba(128,128,128,0.25); }
        .sheet-action-btn.saved { color: var(--text); }
        .sheet-action-btn .material-symbols-rounded { font-size: 20px; }
        .sheet-close {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-left: 12px;
            position: relative;
            z-index: 10;
        }
        .sheet-close:hover { background: rgba(128,128,128,0.1); }
        .sheet-close .material-symbols-rounded { font-size: 24px; }
        
        .event-header { 
            display: flex; 
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px; 
        }
        .event-header-content { flex: 1; }
        .event-title { font-size: 22px; font-weight: 600; margin-bottom: 4px; }
        .event-time { font-size: 15px; color: var(--text-secondary); }
        
        .event-category {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(128,128,128,0.2);
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        .event-venue { 
            font-size: 14px; 
            margin-bottom: 4px; 
        }
        .event-venue a {
            color: var(--text);
            text-decoration: underline;
            text-underline-offset: 3px;
        }
        .event-venue a:hover {
            opacity: 0.7;
        }
        .event-distance { font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; }
        .event-description { font-size: 15px; color: var(--text-secondary); font-style: italic; margin-bottom: 24px; }
        .event-buttons { display: flex; gap: 12px; margin-bottom: 8px; }
        .event-button {
            flex: 1; padding: 14px;
            font-size: 15px; font-weight: 500;
            border-radius: 8px; cursor: pointer;
            text-align: center;
        }
        .event-button.primary { background: var(--text); color: var(--bg); border: none; }
        .event-button.outline { 
            background: transparent; 
            color: var(--text); 
            border: 1.5px solid var(--text); 
        }
        
        /* Share/Reminder Menu */
        .action-menu {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--bg);
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 20px 24px 40px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 4000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        }
        .action-menu.visible { transform: translateY(0); }
        .action-menu-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-align: center;
        }
        .action-menu-options { display: flex; flex-direction: column; gap: 8px; }
        .action-menu-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: rgba(128,128,128,0.1);
            border: none;
            border-radius: 10px;
            color: var(--text);
            font-size: 15px;
            cursor: pointer;
            text-align: left;
            transition: background 0.2s ease;
        }
        .action-menu-option:hover { background: rgba(128,128,128,0.2); }
        .action-menu-option .material-symbols-rounded { font-size: 22px; color: var(--text-secondary); }
        .action-menu-cancel {
            margin-top: 12px;
            width: 100%;
            padding: 14px;
            background: transparent;
            border: 1px solid var(--accent);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 15px;
            cursor: pointer;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--text); color: var(--bg);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 5000;
            text-align: center;
            white-space: pre-line;
        }
        .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Material Icons */
        .material-symbols-rounded {
            font-family: 'Material Symbols Rounded';
            font-weight: normal;
            font-style: normal;
            font-size: inherit;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
        }
    </style>
</head>
<body>
    <!-- Onboarding -->
    <div id="onboarding">
        <svg class="onboarding-logo" viewBox="0 0 319.1 68.54" xmlns="http://www.w3.org/2000/svg">
            <path d="M55.63,8.27h.43l-6.29,24.8h-.43c-7.15-13.18-17.74-21.01-25.14-21.01-2.5,0-3.88.86-4.22,2.07-.86,3.1,4.05,8.09,11.45,13.52l9.56,7.06c6.63,4.91,8.96,10.07,7.23,16.96-2.07,8.53-11.37,16.88-26.09,16.88-8.09,0-14.81-2.5-22.13-3.62l5.42-26.87h.43c7.58,20.41,22.56,25.83,28.42,25.83,2.67,0,3.62-.86,3.62-2.58,0-2.93-3.7-7.15-10.42-12.31l-9.13-7.06c-6.98-5.34-9.39-10.76-7.49-18.34,2.84-11.62,13.35-15.5,23.85-15.5,5.6,0,10.68,1.38,13.95,3.62l6.98-3.44Z"/>
            <path d="M93.09,29.79c-.86,8.61-10.42,14.64-22.65,16.36,1.98,5.51,5.6,9.82,11.19,9.82,2.33,0,4.82-.6,6.89-1.55l.09.43c-5.42,6.89-14.64,13.35-17.14,13.35-9.39,0-18-5.94-17.83-18.34,0-16.53,12.92-29.97,29.28-29.97,4.13,0,10.85,2.84,10.16,9.9ZM76.81,30.14c0-3.87-1.12-6.54-3.62-6.54-2.84,0-4.56,4.99-4.56,11.45,0,3.1.43,6.54,1.29,9.64,4.22-1.38,6.89-8.78,6.89-14.55Z"/>
            <path d="M131.84,29.79c-.86,8.61-10.42,14.64-22.65,16.36,1.98,5.51,5.6,9.82,11.19,9.82,2.33,0,4.82-.6,6.89-1.55l.09.43c-5.42,6.89-14.64,13.35-17.14,13.35-9.39,0-18-5.94-17.83-18.34,0-16.53,12.92-29.97,29.28-29.97,4.13,0,10.85,2.84,10.16,9.9ZM115.56,30.14c0-3.87-1.12-6.54-3.62-6.54-2.84,0-4.56,4.99-4.56,11.45,0,3.1.43,6.54,1.29,9.64,4.22-1.38,6.89-8.78,6.89-14.55Z"/>
            <path d="M171.62,54.34l7.15-3.36.26.6c-11.02,14.12-12.83,16.71-16.88,16.71-4.65,0-6.29-5.77-5.51-13.86l5.6-15.76c.34-.95,2.67-6.72.77-6.72-2.15,0-5.08,5.6-15.67,35.22h-16.36l8.27-32.72-7.15,3.36-.26-.6c11.02-14.12,12.83-16.7,16.88-16.7,4.65,0,6.29,5.77,5.51,13.86l-6.8,24.63h1.03c7.66-22.91,14.64-38.84,24.71-38.84,4.05,0,9.04,2.84,4.91,14.98l-6.63,19.2h.17Z"/>
            <path d="M221.39,54.25l7.15-3.36.26.6c-11.02,14.12-12.83,16.71-16.88,16.71-4.65,0-6.29-5.77-5.51-13.86l6.46-25.49h-1.64c-9.21,36.6-16.53,39.27-22.56,39.27-5.34,0-9.13-4.48-8.52-12.57,1.12-14.64,12.4-35.39,33.07-35.39,4.13,0,7.41.86,9.99,2.93h.09l7.49-2.67h.6l-3.01,8.78-7.15,25.06h.17ZM208.39,22.48c-6.11,0-12.92,23.77-12.92,31.95,0,2.33.69,3.27,2.07,3.27,4.05,0,8.52-17.14,11.54-27.21,2.15-7.15.26-8.01-.69-8.01ZM201.24,8.96c.52-3.36,3.1-5.68,6.54-5.68,3.19,0,4.99,2.33,4.39,5.68-.52,3.44-3.01,5.77-6.2,5.77-3.45,0-5.34-2.33-4.74-5.77ZM217.95,8.96c.52-3.36,3.1-5.68,6.55-5.68,3.19,0,4.99,2.33,4.39,5.68-.52,3.44-3.01,5.77-6.2,5.77-3.44,0-5.34-2.33-4.74-5.77Z"/>
            <path d="M269.62,54.34l7.15-3.36.26.6c-11.02,14.12-12.83,16.71-16.88,16.71-4.65,0-6.29-5.77-5.51-13.86l5.6-15.76c.34-.95,2.67-6.72.78-6.72-2.15,0-5.08,5.6-15.67,35.22h-16.62l14.81-58.73-3.19-1.55.09-.52L261.35.09h.52v.09l.26-.17-16.71,58.99h1.03c7.66-22.91,14.64-38.84,24.71-38.84,4.05,0,9.04,2.84,4.91,14.98l-6.63,19.2h.17Z"/>
            <path d="M319.05,29.79c-.86,8.61-10.42,14.64-22.65,16.36,1.98,5.51,5.6,9.82,11.19,9.82,2.33,0,4.82-.6,6.89-1.55l.09.43c-5.42,6.89-14.64,13.35-17.14,13.35-9.39,0-18-5.94-17.82-18.34,0-16.53,12.92-29.97,29.28-29.97,4.13,0,10.85,2.84,10.16,9.9ZM302.77,30.14c0-3.87-1.12-6.54-3.62-6.54-2.84,0-4.56,4.99-4.56,11.45,0,3.1.43,6.54,1.29,9.64,4.22-1.38,6.89-8.78,6.89-14.55Z"/>
        </svg>
        <p class="onboarding-text" id="onboardingText">Zeigt dir,<br>was in deiner Nähe<br>gerade passiert.</p>
        <button class="onboarding-button" id="startButton" disabled>Lädt Karte...</button>
        <div id="loadingStatus"></div>
    </div>
    
    <!-- App -->
    <div id="app">
        <div id="map"></div>
        
        <!-- Header with Filters only -->
        <div class="header-container">
            <div class="cluster-scroll-wrapper">
                <div class="cluster-pills" id="clusterPills"></div>
            </div>
        </div>
        
        <!-- List View -->
        <div class="list-view" id="listView">
            <div class="list-header">
                <span class="list-header-title" id="listCount">Alle 0 Events</span>
                <button class="sort-dropdown" id="sortBtn">
                    <span id="sortLabel">Nähe</span>
                    <span class="material-symbols-rounded">expand_more</span>
                </button>
            </div>
            <div id="listContent"></div>
        </div>
        
        <!-- View Toggle (Map/List) - above tabbar -->
        <div class="view-toggle" id="viewToggle">
            <button class="toggle-btn active" id="toggleMap">
                <span class="material-symbols-rounded">map</span>
            </button>
            <button class="toggle-btn" id="toggleList">
                <span class="material-symbols-rounded">list</span>
            </button>
        </div>
        
        <!-- Bottom Tabbar -->
        <nav class="tabbar" id="tabbar">
            <button class="tab-item active" id="tabHeute">
                <span class="material-symbols-rounded">today</span>
                <span>Heute</span>
            </button>
            <button class="tab-item" id="tabLaufend">
                <span class="material-symbols-rounded">event_available</span>
                <span>Laufend</span>
            </button>
            <button class="tab-item" id="tabOrte">
                <span class="material-symbols-rounded">location_on</span>
                <span>Orte</span>
            </button>
            <button class="tab-item" id="tabGemerkt">
                <span class="material-symbols-rounded">bookmark</span>
                <span>Gemerkt</span>
                <span class="badge hidden" id="tabBadge">0</span>
            </button>
        </nav>
    </div>
    
    <!-- Backdrop -->
    <div class="backdrop" id="backdrop"></div>
    
    <!-- Event Sheet -->
    <div class="event-sheet" id="eventSheet">
        <div class="sheet-top">
            <div class="event-category" id="sheetCategory">Kategorie</div>
            <div class="sheet-top-actions">
                <button class="sheet-action-btn" id="saveBtn" title="Merken">
                    <span class="material-symbols-rounded">bookmark</span>
                </button>
                <button class="sheet-action-btn" id="shareBtn" title="Teilen">
                    <span class="material-symbols-rounded">share</span>
                </button>
                <button class="sheet-action-btn" id="reminderBtn" title="Reminder">
                    <span class="material-symbols-rounded">notifications</span>
                </button>
                <button class="sheet-close" id="sheetClose">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
        </div>
        <div class="event-header">
            <div class="event-header-content">
                <h2 class="event-title" id="sheetTitle">Event</h2>
                <p class="event-time" id="sheetTime">Zeit</p>
            </div>
        </div>
        <p class="event-venue" id="sheetVenue">Ort</p>
        <p class="event-distance" id="sheetDistance">Entfernung</p>
        <div class="event-buttons">
            <button class="event-button outline" id="detailsBtn">Mehr erfahren</button>
            <button class="event-button primary" id="goBtn">Auf den Weg</button>
        </div>
    </div>
    
    <!-- Share Menu -->
    <div class="action-menu" id="shareMenu">
        <div class="action-menu-title">Teilen über</div>
        <div class="action-menu-options">
            <button class="action-menu-option" id="shareWhatsApp">
                <span class="material-symbols-rounded">chat</span>
                WhatsApp
            </button>
            <button class="action-menu-option" id="shareSignal">
                <span class="material-symbols-rounded">lock</span>
                Signal
            </button>
        </div>
        <button class="action-menu-cancel" id="shareCancel">Abbrechen</button>
    </div>
    
    <!-- Reminder Menu -->
    <div class="action-menu" id="reminderMenu">
        <div class="action-menu-title">Erinnere mich</div>
        <div class="action-menu-options">
            <button class="action-menu-option" id="reminderDay">
                <span class="material-symbols-rounded">calendar_today</span>
                Einen Tag vorher
            </button>
            <button class="action-menu-option" id="reminderHour">
                <span class="material-symbols-rounded">schedule</span>
                Eine Stunde vorher
            </button>
        </div>
        <button class="action-menu-cancel" id="reminderCancel">Abbrechen</button>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Sort Menu -->
    <div class="sort-menu" id="sortMenu">
        <div class="sort-menu-title">Sortieren nach</div>
        <button class="sort-option active" id="sortDistance">
            Nähe
            <span class="material-symbols-rounded">check</span>
        </button>
        <button class="sort-option" id="sortDate">
            Datum
            <span class="material-symbols-rounded">check</span>
        </button>
    </div>
    
    <!-- Bookmarks View -->
    <div class="bookmarks-view" id="bookmarksView">
        <div class="bookmarks-header">
            <button class="bookmarks-back" id="bookmarksBack">
                <span class="material-symbols-rounded">arrow_back</span>
            </button>
            <span class="bookmarks-title">Meine Merkliste</span>
        </div>
        <div class="bookmarks-list" id="bookmarksList"></div>
    </div>
    
    <!-- Venue Detail View -->
    <div class="venue-view" id="venueView">
        <div class="venue-header">
            <button class="bookmarks-back" id="venueBack">
                <span class="material-symbols-rounded">arrow_back</span>
            </button>
            <span class="bookmarks-title clickable" id="venueBackText">Zurück</span>
        </div>
        <div class="venue-content">
            <h1 class="venue-name" id="venueName">Venue Name</h1>
            <p class="venue-type" id="venueType">Kulturstätte</p>
            <p class="venue-description" id="venueDescription">Ein besonderer Ort für Kultur und Begegnung am Bodensee.</p>
            
            <!-- Image Carousel -->
            <div class="venue-carousel" id="venueCarousel">
                <div class="venue-carousel-track" id="venueCarouselTrack">
                    <div class="venue-carousel-slide">
                        <div class="venue-carousel-placeholder">
                            <span class="material-symbols-rounded">photo_camera</span>
                        </div>
                    </div>
                    <div class="venue-carousel-slide">
                        <div class="venue-carousel-placeholder">
                            <span class="material-symbols-rounded">photo_camera</span>
                        </div>
                    </div>
                    <div class="venue-carousel-slide">
                        <div class="venue-carousel-placeholder">
                            <span class="material-symbols-rounded">photo_camera</span>
                        </div>
                    </div>
                    <div class="venue-carousel-slide">
                        <div class="venue-carousel-placeholder">
                            <span class="material-symbols-rounded">photo_camera</span>
                        </div>
                    </div>
                    <div class="venue-carousel-slide">
                        <div class="venue-carousel-placeholder">
                            <span class="material-symbols-rounded">photo_camera</span>
                        </div>
                    </div>
                </div>
                <div class="venue-carousel-dots" id="venueCarouselDots">
                    <span class="venue-carousel-dot active"></span>
                    <span class="venue-carousel-dot"></span>
                    <span class="venue-carousel-dot"></span>
                    <span class="venue-carousel-dot"></span>
                    <span class="venue-carousel-dot"></span>
                </div>
            </div>
            
            <div class="venue-section-title">Kontakt</div>
            <div class="venue-info-row">
                <span class="material-symbols-rounded">location_on</span>
                <span class="venue-info-text" id="venueAddress">Adresse</span>
            </div>
            <div class="venue-info-row">
                <span class="material-symbols-rounded">language</span>
                <span class="venue-info-text" id="venueWebsite">Website</span>
            </div>
            
            <div class="venue-events-title">Events an diesem Ort</div>
            <div class="venue-events-list" id="venueEventsList"></div>
            
            <div class="venue-section-title">Öffnungszeiten</div>
            <div class="venue-hours" id="venueHours">
                <div class="venue-hours-row">
                    <span class="venue-hours-day">Montag</span>
                    <span class="venue-hours-time" id="hoursMon">10:00 – 18:00</span>
                </div>
                <div class="venue-hours-row">
                    <span class="venue-hours-day">Dienstag</span>
                    <span class="venue-hours-time" id="hoursTue">10:00 – 18:00</span>
                </div>
                <div class="venue-hours-row">
                    <span class="venue-hours-day">Mittwoch</span>
                    <span class="venue-hours-time" id="hoursWed">10:00 – 18:00</span>
                </div>
                <div class="venue-hours-row">
                    <span class="venue-hours-day">Donnerstag</span>
                    <span class="venue-hours-time" id="hoursThu">10:00 – 21:00</span>
                </div>
                <div class="venue-hours-row">
                    <span class="venue-hours-day">Freitag</span>
                    <span class="venue-hours-time" id="hoursFri">10:00 – 18:00</span>
                </div>
                <div class="venue-hours-row">
                    <span class="venue-hours-day">Samstag</span>
                    <span class="venue-hours-time" id="hoursSat">10:00 – 18:00</span>
                </div>
                <div class="venue-hours-row">
                    <span class="venue-hours-day">Sonntag</span>
                    <span class="venue-hours-time" id="hoursSun">11:00 – 17:00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>
    
    <script>
    // =============================================
    // INITIALIZATION
    // =============================================
    
    (function init() {
        var statusEl = document.getElementById('loadingStatus');
        var buttonEl = document.getElementById('startButton');
        var textEl = document.getElementById('onboardingText');
        
        // Set random onboarding message
        var messages = [
            { text: "Der See ist voller Leben.\n\nDu musst nur\nnah genug kommen.", cta: "Näher kommen" },
            { text: "Am See ist nichts weit.\n\nDie Frage ist nicht: Wo?\nDie Frage ist: Wann?", cta: "Jetzt" },
            { text: "Was wenn dein Lieblingsort\nnoch gar nicht\ndein Lieblingsort ist?", cta: "Finden" },
            { text: "Manchmal ist das Beste:\n\nEinfach loszugehen.", cta: "Losgehen" },
            { text: "Drei Länder.\nEin See.\n\nUnendlich viele Momente.", cta: "Momente erleben" }
        ];
        var randomMsg = messages[Math.floor(Math.random() * messages.length)];
        textEl.innerHTML = randomMsg.text.replace(/\n/g, '<br>');
        
        function checkReady() {
            if (typeof L !== 'undefined' && L.map) {
                statusEl.textContent = '';
                buttonEl.textContent = randomMsg.cta;
                buttonEl.disabled = false;
                buttonEl.onclick = startApp;
            } else {
                statusEl.textContent = 'Lädt...';
                setTimeout(checkReady, 100);
            }
        }
        checkReady();
    })();
    
    // =============================================
    // DATA
    // =============================================
    
    // Filter categories for "Heute" (events)
    var CLUSTERS_HEUTE = {
        musik: { icon: 'music_note', name: 'Musik' },
        buehne: { icon: 'theater_comedy', name: 'Bühne' },
        wort: { icon: 'mic', name: 'Wort' },
        party: { icon: 'nightlife', name: 'Party' },
        kunst: { icon: 'palette', name: 'Kunst' },
        maerkte: { icon: 'storefront', name: 'Märkte' },
        wissen: { icon: 'school', name: 'Wissen' },
        genuss: { icon: 'restaurant', name: 'Genuss' },
        sport: { icon: 'sports_soccer', name: 'Sport' },
        familie: { icon: 'family_restroom', name: 'Familie' }
    };
    
    // Filter categories for "Laufend" (ongoing events/exhibitions)
    var CLUSTERS_LAUFEND = {
        ausstellungen: { icon: 'museum', name: 'Ausstellungen' },
        saison: { icon: 'event_available', name: 'Saison' },
        fuehrungen: { icon: 'directions_walk', name: 'Führungen' },
        abos: { icon: 'loyalty', name: 'Abos' },
        kurse: { icon: 'class', name: 'Kurse' }
    };
    
    // Filter categories for "Orte" (venues)
    var CLUSTERS_ORTE = {
        museen: { icon: 'museum', name: 'Museen' },
        buehnen: { icon: 'theater_comedy', name: 'Bühnen' },
        zentren: { icon: 'location_city', name: 'Zentren' },
        kirchen: { icon: 'church', name: 'Kirchen' },
        sport: { icon: 'sports', name: 'Sport' }
    };
    
    // Active clusters based on nav mode
    var CLUSTERS = CLUSTERS_HEUTE;
    
    var currentNav = 'jetzt'; // 'jetzt', 'laeuft', 'orte'
    var nearbyEvents = [];
    var currentEventIndex = 0;
    var activeMarkerElement = null;
    var swipeStartX = 0;
    var swipeCurrentX = 0;
    var isSwiping = false;
    
    // 47 real venues from Bodensee region
    var VENUES = [
        {name: "Theater Konstanz", address: "Konzilstraße 11, 78462 Konstanz", lat: 47.6620, lng: 9.1760, country: "D", region: "Konstanz", category: "KULT", slug: "theater-konstanz"},
        {name: "Kulturladen (Kula)", address: "Joseph-Belli-Weg 5, 78467 Konstanz", lat: 47.6780, lng: 9.1600, country: "D", region: "Konstanz", category: "MUS", slug: "kulturladen-konstanz"},
        {name: "Bodenseeforum", address: "Reichenaustr. 21, 78467 Konstanz", lat: 47.6710, lng: 9.1670, country: "D", region: "Konstanz", category: "MICE", slug: "bodenseeforum"},
        {name: "Berry's", address: "Reichenaustr. 204, 78467 Konstanz", lat: 47.6790, lng: 9.1550, country: "D", region: "Konstanz", category: "MUS", slug: "berrys-konstanz"},
        {name: "Bodenseestadion", address: "Eichhornstr. 89, 78464 Konstanz", lat: 47.6680, lng: 9.2130, country: "D", region: "Konstanz", category: "SPORT", slug: "bodenseestadion"},
        {name: "Insel Mainau", address: "Insel Mainau, 78465 Insel Mainau", lat: 47.7050, lng: 9.1970, country: "D", region: "Konstanz", category: "FAM", slug: "insel-mainau"},
        {name: "K9 Kulturzentrum", address: "Hieronymusgasse 3, 78462 Konstanz", lat: 47.6600, lng: 9.1730, country: "D", region: "Konstanz", category: "WORT", slug: "k9-kulturzentrum"},
        {name: "Staatsweingut Meersburg", address: "Seminarstraße 6, 88709 Meersburg", lat: 47.6940, lng: 9.2710, country: "D", region: "Bodenseekreis", category: "GAST", slug: "staatsweingut-meersburg"},
        {name: "Graf-Zeppelin-Haus", address: "Olgastraße 20, 88045 Friedrichshafen", lat: 47.6490, lng: 9.4770, country: "D", region: "Bodenseekreis", category: "MICE", slug: "graf-zeppelin-haus"},
        {name: "Zeppelin Museum", address: "Seestraße 22, 88045 Friedrichshafen", lat: 47.6500, lng: 9.4820, country: "D", region: "Bodenseekreis", category: "KULT", slug: "zeppelin-museum"},
        {name: "Messe Friedrichshafen", address: "Neue Messe 1, 88046 Friedrichshafen", lat: 47.6781, lng: 9.5060, country: "D", region: "Bodenseekreis", category: "MICE", slug: "messe-friedrichshafen"},
        {name: "Spacetech Arena", address: "Flughafen 28/2, 88046 Friedrichshafen", lat: 47.6720, lng: 9.5230, country: "D", region: "Bodenseekreis", category: "SPORT", slug: "spacetech-arena"},
        {name: "Ravensburger Spieleland", address: "Am Hangenwald 1, 88074 Meckenbeuren", lat: 47.7110, lng: 9.5920, country: "D", region: "Bodenseekreis", category: "FAM", slug: "ravensburger-spieleland"},
        {name: "Kunstmuseum Ravensburg", address: "Burgstraße 9, 88212 Ravensburg", lat: 47.7810, lng: 9.6140, country: "D", region: "Ravensburg", category: "KULT", slug: "kunstmuseum-ravensburg"},
        {name: "Zehntscheuer", address: "Grüner-Turm-Str. 30, 88212 Ravensburg", lat: 47.7820, lng: 9.6130, country: "D", region: "Ravensburg", category: "WORT", slug: "zehntscheuer-ravensburg"},
        {name: "Club Douala", address: "Schubertstraße 2, 88214 Ravensburg", lat: 47.7710, lng: 9.6080, country: "D", region: "Ravensburg", category: "MUS", slug: "club-douala"},
        {name: "Brauerei Leibinger", address: "Friedhofstr. 20-36, 88212 Ravensburg", lat: 47.7790, lng: 9.6090, country: "D", region: "Ravensburg", category: "GAST", slug: "brauerei-leibinger"},
        {name: "Oberschwabenhalle", address: "Bleicherstraße 20, 88212 Ravensburg", lat: 47.7760, lng: 9.6120, country: "D", region: "Ravensburg", category: "MICE", slug: "oberschwabenhalle"},
        {name: "Inselhalle Lindau", address: "Zwanzigerstraße 10, 88131 Lindau", lat: 47.5480, lng: 9.6810, country: "D", region: "Lindau", category: "MICE", slug: "inselhalle-lindau"},
        {name: "Stadthalle Singen", address: "Hohgarten 4, 78224 Singen", lat: 47.7630, lng: 8.8350, country: "D", region: "Konstanz", category: "KULT", slug: "stadthalle-singen"},
        {name: "Kunstmuseum Singen", address: "Ekkehardstraße 10, 78224 Singen", lat: 47.7620, lng: 8.8320, country: "D", region: "Konstanz", category: "KULT", slug: "kunstmuseum-singen"},
        {name: "Flipped Funpark", address: "Robert-Bosch-Str. 5, 78224 Singen", lat: 47.7550, lng: 8.8550, country: "D", region: "Konstanz", category: "FAM", slug: "flipped-funpark"},
        {name: "Festspielhaus Bregenz", address: "Platz d. Wr. Symphoniker 1, 6900 Bregenz", lat: 47.5050, lng: 9.7370, country: "A", region: "Bregenz", category: "KULT", slug: "festspielhaus-bregenz"},
        {name: "Kunsthaus Bregenz (KUB)", address: "Karl-Tizian-Platz, 6900 Bregenz", lat: 47.5040, lng: 9.7470, country: "A", region: "Bregenz", category: "KULT", slug: "kunsthaus-bregenz"},
        {name: "Pfänderbahn", address: "Steinbruchgasse 4, 6900 Bregenz", lat: 47.5060, lng: 9.7530, country: "A", region: "Bregenz", category: "FAM", slug: "pfaenderbahn"},
        {name: "Handball Arena", address: "Burggräflergasse 11, 6900 Bregenz", lat: 47.4920, lng: 9.7230, country: "A", region: "Bregenz", category: "SPORT", slug: "handball-arena-bregenz"},
        {name: "inatura", address: "Jahngasse 9, 6850 Dornbirn", lat: 47.4110, lng: 9.7460, country: "A", region: "Dornbirn", category: "EDU", slug: "inatura-dornbirn"},
        {name: "Messe Dornbirn", address: "Messeplatz 1, 6850 Dornbirn", lat: 47.4090, lng: 9.7100, country: "A", region: "Dornbirn", category: "MICE", slug: "messe-dornbirn"},
        {name: "Sender Club", address: "Hofsteigstraße 54, 6890 Lustenau", lat: 47.4410, lng: 9.6550, country: "A", region: "Dornbirn", category: "MUS", slug: "sender-club"},
        {name: "Theater am Saumarkt", address: "Mühletorplatz 1, 6800 Feldkirch", lat: 47.2370, lng: 9.5980, country: "A", region: "Feldkirch", category: "WORT", slug: "theater-saumarkt"},
        {name: "Theater St. Gallen", address: "Museumstrasse 24, 9000 St. Gallen", lat: 47.4260, lng: 9.3790, country: "CH", region: "St. Gallen", category: "KULT", slug: "theater-st-gallen"},
        {name: "Kunstmuseum St. Gallen", address: "Museumstrasse 32, 9000 St. Gallen", lat: 47.4260, lng: 9.3800, country: "CH", region: "St. Gallen", category: "KULT", slug: "kunstmuseum-st-gallen"},
        {name: "Lokremise", address: "Grünbergstrasse 7, 9000 St. Gallen", lat: 47.4220, lng: 9.3680, country: "CH", region: "St. Gallen", category: "KULT", slug: "lokremise"},
        {name: "Olma Messen", address: "Splügenstrasse 12, 9008 St. Gallen", lat: 47.4310, lng: 9.3820, country: "CH", region: "St. Gallen", category: "MICE", slug: "olma-messen"},
        {name: "Kugl (Kultur am Gleis)", address: "Güterbahnhofstr. 4, 9000 St. Gallen", lat: 47.4190, lng: 9.3660, country: "CH", region: "St. Gallen", category: "MUS", slug: "kugl-st-gallen"},
        {name: "Würth Haus", address: "Churerstrasse 10, 9400 Rorschach", lat: 47.4780, lng: 9.4970, country: "CH", region: "St. Gallen", category: "MICE", slug: "wuerth-haus"},
        {name: "Bodensee-Arena", address: "Seestrasse 11b, 8280 Kreuzlingen", lat: 47.6530, lng: 9.1790, country: "CH", region: "Thurgau", category: "SPORT", slug: "bodensee-arena"},
        {name: "Conny-Land", address: "Connylandstr. 1, 8564 Lipperswil", lat: 47.6140, lng: 9.0570, country: "CH", region: "Thurgau", category: "FAM", slug: "conny-land"},
        {name: "Casinotheater", address: "Stadthausstr. 119, 8400 Winterthur", lat: 47.5000, lng: 8.7290, country: "CH", region: "Zürich", category: "WORT", slug: "casinotheater-winterthur"},
        {name: "Technorama", address: "Technoramastr. 1, 8404 Winterthur", lat: 47.5130, lng: 8.7640, country: "CH", region: "Zürich", category: "EDU", slug: "technorama"},
        {name: "Stadion Schützenwiese", address: "Rennweg 5, 8400 Winterthur", lat: 47.5020, lng: 8.7180, country: "CH", region: "Zürich", category: "SPORT", slug: "stadion-schuetzenwiese"},
        {name: "Hopfengut No20", address: "Hopfengut 20, 88069 Tettnang", lat: 47.6580, lng: 9.6150, country: "D", region: "Bodenseekreis", category: "GAST", slug: "hopfengut-no20"},
        {name: "Brauerei Schützengarten", address: "St. Jakob-Str. 37, 9004 St. Gallen", lat: 47.4280, lng: 9.3800, country: "CH", region: "St. Gallen", category: "GAST", slug: "brauerei-schuetzengarten"},
        {name: "Mohren Brauerei", address: "Dr.-Waibel-Str. 2, 6850 Dornbirn", lat: 47.4140, lng: 9.7420, country: "A", region: "Dornbirn", category: "GAST", slug: "mohren-brauerei"},
        {name: "Kunstmuseum Liechtenstein", address: "Städtle 32, 9490 Vaduz", lat: 47.1390, lng: 9.5220, country: "FL", region: "Vaduz", category: "KULT", slug: "kunstmuseum-liechtenstein"},
        {name: "Theater an der Grenze", address: "Hauptstrasse 55a, 8280 Kreuzlingen", lat: 47.6470, lng: 9.1720, country: "CH", region: "Thurgau", category: "WORT", slug: "theater-grenze"}
    ];
    
    // Event name templates per category
    var EVENT_NAMES = {
        musik: ["Jazz Session", "Klassik am See", "Indie Night", "Akustik Abend", "Brass Band Live", "Singer-Songwriter", "Electronic Vibes", "Weltmusik Festival", "Blues Evening", "Chorkonzert"],
        buehne: ["Hamlet Revisited", "Impro-Show", "Tanztheater", "Musical Gala", "Oper für Alle", "Ballett Premiere", "Kabarett Nacht", "Schauspiel", "Experimentelles Theater", "Die Physiker"],
        wort: ["Stand-Up Comedy", "Kabarett", "Autorenlesung", "Poetry Slam", "Vortrag: KI", "Diskussionsabend", "Märchenabend", "Krimiabend", "Philosophie-Café", "Spoken Word"],
        party: ["Techno Night", "80er Party", "Latin Fiesta", "House Session", "Afterwork Party", "Neon Nights", "Salsa Club", "Indie Disco", "Hip-Hop Jam", "Sommernachtstraum"],
        kunst: ["Neue Ausstellung", "Vernissage", "Fotoausstellung", "Skulpturen Open Air", "Galerie-Rundgang", "Kunstfilm", "Installation", "Keramik-Schau", "Druckgrafik", "Videokunst"],
        maerkte: ["Wochenmarkt", "Flohmarkt", "Kunsthandwerk", "Bauernmarkt", "Antiquitäten", "Designmarkt", "Streetfood Festival", "Nachtflohmarkt", "Bio-Markt", "Weihnachtsmarkt"],
        wissen: ["Workshop: Foto", "Coding für Anfänger", "Stadtführung", "Weinwissen", "Astronomie-Abend", "Sprachkurs", "Erste Hilfe", "Schreibwerkstatt", "History Walk", "Naturführung"],
        genuss: ["Weinprobe", "Craft Beer Tasting", "Dinner im Dunkeln", "Käse & Wein", "Fischmarkt", "Brunch Club", "Whisky Tasting", "Schokoladen-Workshop", "Streetfood Tour", "Gin Tasting"],
        sport: ["Fußball Live", "Handball Match", "Beach Volleyball", "Public Viewing", "Lauftreff", "Yoga am See", "Eishockey", "Schwimmwettkampf", "Tennis Open", "Triathlon"],
        familie: ["Kindertheater", "Zirkus", "Puppenspiel", "Familienkonzert", "Bastelnachmittag", "Kinderkino", "Märchenstunde", "Zaubershow", "Mitmach-Museum", "Abenteuerpark"]
    };
    
    // Generate 3 events per venue (141 total)
    var EVENTS = [];
    (function() {
        var id = 0;
        var clusterKeys = Object.keys(CLUSTERS_HEUTE);
        
        // Realistic event times (hour, minute)
        var eventTimes = [
            [10, 0], [11, 0], [14, 0], [15, 0], [16, 0], 
            [17, 0], [18, 0], [19, 0], [19, 30], [20, 0], 
            [20, 30], [21, 0]
        ];
        
        for (var v = 0; v < VENUES.length; v++) {
            var venue = VENUES[v];
            
            // Create 3 events per venue
            for (var e = 0; e < 3; e++) {
                var cluster = clusterKeys[Math.floor(Math.random() * clusterKeys.length)];
                var names = EVENT_NAMES[cluster];
                var eventName = names[Math.floor(Math.random() * names.length)];
                
                // Random day within next 14 days
                var daysAhead = Math.floor(Math.random() * 14);
                var eventDate = new Date();
                eventDate.setDate(eventDate.getDate() + daysAhead);
                
                // Set realistic time
                var timeSlot = eventTimes[Math.floor(Math.random() * eventTimes.length)];
                eventDate.setHours(timeSlot[0], timeSlot[1], 0, 0);
                
                EVENTS.push({
                    id: id++,
                    title: eventName,
                    cluster: cluster,
                    venue: venue.name,
                    venueSlug: venue.slug,
                    lat: venue.lat,
                    lng: venue.lng,
                    datetime: eventDate,
                    description: "Erlebe " + eventName + " live in " + venue.name + "."
                });
            }
        }
    })();
    
    // Generate EVENTS_LAUFEND (ongoing exhibitions) for museum venues
    var EVENTS_LAUFEND = [];
    (function generateLaufendEvents() {
        var exhibitionTitles = [
            "Lichter des Sees", "Heimat und Horizont", "Wasserwelten", "Zeitenwende",
            "Farben der Region", "Stille Momente", "Grenzenlos", "Spiegelungen",
            "Naturgewalten", "Menschenbilder", "Industriekultur", "Alpenpanorama",
            "Verborgene Schätze", "Moderne Perspektiven", "Tradition und Innovation",
            "Bodensee-Impressionen", "Künstlerkolonie", "Zeitgenössisch", "Retrospektive",
            "Skulpturen am See", "Fotografie heute", "Design und Form", "Architektur erleben"
        ];
        
        var exhibitionTypes = ["Dauerausstellung", "Sonderausstellung", "Wechselausstellung"];
        
        var museumVenues = VENUES.filter(function(v) {
            return v.category === 'KULT' || v.category === 'EDU';
        });
        
        var id = 10000;
        for (var i = 0; i < museumVenues.length; i++) {
            var venue = museumVenues[i];
            
            // Create 3 exhibitions per museum
            for (var e = 0; e < 3; e++) {
                var title = exhibitionTitles[Math.floor(Math.random() * exhibitionTitles.length)];
                var type = exhibitionTypes[Math.floor(Math.random() * exhibitionTypes.length)];
                
                // Start date: random day in past 30 days
                var startDate = new Date();
                startDate.setDate(startDate.getDate() - Math.floor(Math.random() * 30));
                
                // End date: 2 weeks to 6 months from now (or ongoing for Dauerausstellung)
                var endDate = new Date();
                if (type === "Dauerausstellung") {
                    endDate = null; // Ongoing
                } else {
                    endDate.setDate(endDate.getDate() + 14 + Math.floor(Math.random() * 150));
                }
                
                EVENTS_LAUFEND.push({
                    id: id++,
                    title: title,
                    cluster: 'ausstellungen',
                    type: type,
                    venue: venue.name,
                    venueSlug: venue.slug,
                    lat: venue.lat,
                    lng: venue.lng,
                    startDate: startDate,
                    endDate: endDate,
                    description: type + " im " + venue.name
                });
            }
        }
    })();
    
    // =============================================
    // STATE
    // =============================================
    
    var map = null;
    var markerClusterGroup = null;
    var markersOnMap = [];
    var userLat = 47.781;
    var userLng = 9.614;
    var activeFilters = [];
    var currentEvent = null;
    var currentZoom = 12;
    var ZOOM_THRESHOLD = 14;
    var currentView = 'map'; // 'map' or 'list'
    var currentSort = 'distance'; // 'distance' or 'date'
    
    // =============================================
    // FUNCTIONS
    // =============================================
    
    function startApp() {
        document.getElementById('onboarding').classList.add('hidden');
        document.getElementById('app').classList.add('visible');
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    userLat = pos.coords.latitude;
                    userLng = pos.coords.longitude;
                    initializeMap();
                },
                function() { initializeMap(); },
                { enableHighAccuracy: true, timeout: 5000 }
            );
        } else {
            initializeMap();
        }
    }
    
    function initializeMap() {
        var isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            minZoom: 9,
            maxBounds: [[47.0, 8.5], [48.2, 10.2]],
            maxBoundsViscosity: 1.0
        }).setView([userLat, userLng], 10);
        
        // Try loading tiles
        var tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            subdomains: ['a', 'b', 'c']
        });
        
        tileLayer.on('tileerror', function(e) {
            console.log('Tile loading error - network may be restricted');
        });
        
        tileLayer.addTo(map);
        
        // Apply grayscale filter via CSS on the tile pane
        var tilePane = map.getPane('tilePane');
        if (tilePane) {
            if (isDarkMode) {
                tilePane.style.filter = 'grayscale(100%) invert(100%) brightness(0.6) contrast(1.2)';
            } else {
                tilePane.style.filter = 'grayscale(100%) brightness(1.1) contrast(0.9)';
            }
        }
        
        // Listen for dark mode changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
            var pane = map.getPane('tilePane');
            if (pane) {
                if (e.matches) {
                    pane.style.filter = 'grayscale(100%) invert(100%) brightness(0.6) contrast(1.2)';
                } else {
                    pane.style.filter = 'grayscale(100%) brightness(1.1) contrast(0.9)';
                }
            }
        });
        
        // User marker
        var userIcon = L.divIcon({
            className: '',
            html: '<div class="user-marker"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        L.marker([userLat, userLng], { icon: userIcon, zIndexOffset: 1000 }).addTo(map);
        
        // Marker cluster group
        markerClusterGroup = L.markerClusterGroup({
            showCoverageOnHover: false,
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: false,
            disableClusteringAtZoom: ZOOM_THRESHOLD,
            iconCreateFunction: function(cluster) {
                var count = cluster.getChildCount();
                var size = count < 10 ? 36 : count < 50 ? 42 : 48;
                var markerClass = currentNav === 'orte' ? 'venue-cluster-marker' : 'cluster-marker';
                return L.divIcon({
                    html: '<div class="' + markerClass + '" style="width:' + size + 'px;height:' + size + 'px;">' + count + '</div>',
                    className: '',
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
            }
        });
        map.addLayer(markerClusterGroup);
        
        currentZoom = map.getZoom();
        map.on('zoomend', function() {
            currentZoom = map.getZoom();
            updateMarkers();
        });
        
        buildClusterPills();
        updateMarkers();
        
        // Event handlers
        document.getElementById('backdrop').onclick = closeSheet;
        document.getElementById('backdrop').addEventListener('touchend', function(e) { e.preventDefault(); closeSheet(); });
        
        var sheetCloseBtn = document.getElementById('sheetClose');
        sheetCloseBtn.onclick = closeSheet;
        sheetCloseBtn.addEventListener('touchend', function(e) { 
            e.preventDefault(); 
            e.stopPropagation();
            closeSheet(); 
        });
        
        var goBtn = document.getElementById('goBtn');
        goBtn.onclick = goToEvent;
        goBtn.addEventListener('touchend', function(e) { e.preventDefault(); goToEvent(); });
        
        var detailsBtn = document.getElementById('detailsBtn');
        detailsBtn.onclick = openEventDetails;
        detailsBtn.addEventListener('touchend', function(e) { e.preventDefault(); openEventDetails(); });
        
        // Navigation toggle handlers (Jetzt/Läuft/Orte)
        // Tabbar handlers
        document.getElementById('tabHeute').onclick = function() { setNavMode('jetzt'); };
        document.getElementById('tabLaufend').onclick = function() { setNavMode('laeuft'); };
        document.getElementById('tabOrte').onclick = function() { setNavMode('orte'); };
        document.getElementById('tabGemerkt').onclick = function() { setNavMode('gemerkt'); };
        
        // View toggle handlers (Map/List)
        document.getElementById('toggleMap').onclick = function() {
            setView('map');
        };
        document.getElementById('toggleList').onclick = function() {
            setView('list');
        };
        
        // Swipe handlers for event sheet
        var eventSheet = document.getElementById('eventSheet');
        eventSheet.addEventListener('touchstart', handleSwipeStart, { passive: true });
        eventSheet.addEventListener('touchmove', handleSwipeMove, { passive: false });
        eventSheet.addEventListener('touchend', handleSwipeEnd, { passive: true });
        
        // Venue detail handler
        document.getElementById('venueBack').onclick = closeVenueDetail;
        document.getElementById('venueBackText').onclick = closeVenueDetail;
        
        // Sort handlers
        document.getElementById('sortBtn').onclick = function() {
            document.getElementById('sortMenu').classList.add('visible');
        };
        document.getElementById('sortDistance').onclick = function() {
            setSort('distance');
        };
        document.getElementById('sortDate').onclick = function() {
            setSort('date');
        };
        
        // Save button
        document.getElementById('saveBtn').onclick = toggleSave;
        
        // Share button & menu
        document.getElementById('shareBtn').onclick = function() {
            document.getElementById('shareMenu').classList.add('visible');
        };
        document.getElementById('shareCancel').onclick = function() {
            document.getElementById('shareMenu').classList.remove('visible');
        };
        document.getElementById('shareWhatsApp').onclick = shareWhatsApp;
        document.getElementById('shareSignal').onclick = shareSignal;
        
        // Reminder button & menu
        document.getElementById('reminderBtn').onclick = function() {
            document.getElementById('reminderMenu').classList.add('visible');
        };
        document.getElementById('reminderCancel').onclick = function() {
            document.getElementById('reminderMenu').classList.remove('visible');
        };
        document.getElementById('reminderDay').onclick = function() { setReminder('day'); };
        document.getElementById('reminderHour').onclick = function() { setReminder('hour'); };
    }
    
    function buildClusterPills() {
        var container = document.getElementById('clusterPills');
        container.innerHTML = '';
        
        var keys = Object.keys(CLUSTERS);
        for (var i = 0; i < keys.length; i++) {
            var cluster = keys[i];
            var data = CLUSTERS[cluster];
            var pill = document.createElement('button');
            pill.className = 'cluster-pill';
            pill.id = 'pill-' + cluster;
            pill.setAttribute('data-cluster', cluster);
            // Capitalize first letter of label
            var label = data.name.charAt(0).toUpperCase() + data.name.slice(1);
            pill.innerHTML = '<span class="material-symbols-rounded">' + data.icon + '</span>' + label + '<span class="count" id="count-' + cluster + '">(0)</span>';
            (function(c, p) {
                pill.onclick = function() { toggleFilter(c, p); };
            })(cluster, pill);
            container.appendChild(pill);
        }
    }
    
    function toggleFilter(cluster, pill) {
        if (pill.classList.contains('active')) {
            pill.classList.remove('active');
            activeFilters = activeFilters.filter(function(f) { return f !== cluster; });
        } else {
            pill.classList.add('active');
            activeFilters.push(cluster);
        }
        updateMarkers();
        if (currentView === 'list') {
            renderList();
        }
    }
    
    function filterByCategory(cluster) {
        // Clear all filters first
        activeFilters = [];
        var pills = document.querySelectorAll('.cluster-pill');
        pills.forEach(function(pill) {
            pill.classList.remove('active');
        });
        
        // Set the specific filter
        var pill = document.getElementById('pill-' + cluster);
        if (pill) {
            pill.classList.add('active');
            activeFilters.push(cluster);
            
            // Scroll pill into view
            pill.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        }
        
        updateMarkers();
        renderList();
        
        showToast('Filter: ' + CLUSTERS[cluster].name);
    }
    
    function calcDistance(lat1, lng1, lat2, lng2) {
        var R = 6371000;
        var dLat = (lat2 - lat1) * Math.PI / 180;
        var dLng = (lng2 - lng1) * Math.PI / 180;
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLng/2) * Math.sin(dLng/2);
        return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }
    
    function updateMarkers() {
        // Clear existing markers
        markerClusterGroup.clearLayers();
        
        var visibleCount = 0;
        var showIcons = currentZoom >= ZOOM_THRESHOLD;
        
        // "Orte" mode shows venues
        if (currentNav === 'orte') {
            var venueCategoryMap = {
                'KULT': 'museen',
                'MUS': 'buehnen',
                'MICE': 'zentren',
                'WORT': 'buehnen',
                'GAST': 'zentren',
                'SPORT': 'sport',
                'FAM': 'zentren',
                'EDU': 'museen'
            };
            
            for (var v = 0; v < VENUES.length; v++) {
                var venue = VENUES[v];
                var venueFilter = venueCategoryMap[venue.category] || 'zentren';
                
                if (activeFilters.length > 0 && activeFilters.indexOf(venueFilter) === -1) {
                    continue;
                }
                
                visibleCount++;
                var distance = calcDistance(userLat, userLng, venue.lat, venue.lng);
                
                var size = showIcons ? 32 : 12;
                var markerHtml;
                if (showIcons) {
                    var iconName = CLUSTERS[venueFilter] ? CLUSTERS[venueFilter].icon : 'location_on';
                    markerHtml = '<div class="venue-marker" style="width:' + size + 'px;height:' + size + 'px;"><span class="material-symbols-rounded" style="font-size:16px;">' + iconName + '</span></div>';
                } else {
                    markerHtml = '<div class="venue-marker" style="width:' + size + 'px;height:' + size + 'px;"></div>';
                }
                
                var icon = L.divIcon({
                    className: '',
                    html: markerHtml,
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
                
                var marker = L.marker([venue.lat, venue.lng], { icon: icon });
                
                (function(ven, dist) {
                    marker.on('click', function() { openVenueSheet(ven, dist); });
                })(venue, distance);
                
                markerClusterGroup.addLayer(marker);
            }
            return;
        }
        
        // "Laufend" mode shows EVENTS_LAUFEND
        if (currentNav === 'laeuft') {
            var clusterCounts = {};
            var keys = Object.keys(CLUSTERS);
            for (var k = 0; k < keys.length; k++) {
                clusterCounts[keys[k]] = 0;
            }
            
            for (var i = 0; i < EVENTS_LAUFEND.length; i++) {
                var event = EVENTS_LAUFEND[i];
                
                if (CLUSTERS[event.cluster]) {
                    clusterCounts[event.cluster]++;
                }
                
                if (activeFilters.length > 0 && activeFilters.indexOf(event.cluster) === -1) {
                    continue;
                }
                
                if (!CLUSTERS[event.cluster]) {
                    continue;
                }
                
                visibleCount++;
                var distance = calcDistance(userLat, userLng, event.lat, event.lng);
                
                var size = showIcons ? 36 : 12;
                var markerHtml;
                if (showIcons) {
                    markerHtml = '<div class="event-marker" data-event-id="' + event.id + '" style="width:' + size + 'px;height:' + size + 'px;"><span class="material-symbols-rounded" style="font-size:18px;">' + CLUSTERS[event.cluster].icon + '</span></div>';
                } else {
                    markerHtml = '<div class="event-marker" data-event-id="' + event.id + '" style="width:' + size + 'px;height:' + size + 'px;"></div>';
                }
                
                var icon = L.divIcon({
                    className: '',
                    html: markerHtml,
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
                
                var marker = L.marker([event.lat, event.lng], { icon: icon });
                
                (function(ev, dist) {
                    marker.on('click', function() { openSheetLaufend(ev, dist); });
                })(event, distance);
                
                markerClusterGroup.addLayer(marker);
            }
            
            for (var j = 0; j < keys.length; j++) {
                var countEl = document.getElementById('count-' + keys[j]);
                if (countEl) {
                    countEl.textContent = '(' + (clusterCounts[keys[j]] || 0) + ')';
                }
            }
            return;
        }
        
        // "Heute" mode shows EVENTS
        var clusterCounts = {};
        var keys = Object.keys(CLUSTERS);
        for (var k = 0; k < keys.length; k++) {
            clusterCounts[keys[k]] = 0;
        }
        
        for (var i = 0; i < EVENTS.length; i++) {
            var event = EVENTS[i];
            
            if (CLUSTERS[event.cluster]) {
                clusterCounts[event.cluster]++;
            }
            
            if (activeFilters.length > 0 && activeFilters.indexOf(event.cluster) === -1) {
                continue;
            }
            
            if (!CLUSTERS[event.cluster]) {
                continue;
            }
            
            visibleCount++;
            var distance = calcDistance(userLat, userLng, event.lat, event.lng);
            
            var size = showIcons ? 36 : 12;
            var theaterClass = event.cluster === 'buehne' ? ' theater' : '';
            var markerHtml;
            if (showIcons) {
                markerHtml = '<div class="event-marker' + theaterClass + '" data-event-id="' + event.id + '" style="width:' + size + 'px;height:' + size + 'px;"><span class="material-symbols-rounded" style="font-size:18px;">' + CLUSTERS[event.cluster].icon + '</span></div>';
            } else {
                markerHtml = '<div class="event-marker' + theaterClass + '" data-event-id="' + event.id + '" style="width:' + size + 'px;height:' + size + 'px;"></div>';
            }
            
            var icon = L.divIcon({
                className: '',
                html: markerHtml,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
            
            var marker = L.marker([event.lat, event.lng], { icon: icon });
            
            (function(ev, dist) {
                marker.on('click', function() { openSheet(ev, dist); });
            })(event, distance);
            
            markerClusterGroup.addLayer(marker);
        }
        
        for (var j = 0; j < keys.length; j++) {
            var countEl = document.getElementById('count-' + keys[j]);
            if (countEl) {
                countEl.textContent = '(' + (clusterCounts[keys[j]] || 0) + ')';
            }
        }
    }
    
    function formatTime(date) {
        var now = new Date();
        var diff = date - now;
        var hours = Math.floor(diff / 3600000);
        
        if (hours < 0) return 'Vorbei';
        if (hours < 1) return 'Gleich';
        
        var h = date.getHours();
        var m = String(date.getMinutes()).padStart(2, '0');
        
        if (hours < 24) return 'Heute, ' + h + ':' + m;
        if (hours < 48) return 'Morgen, ' + h + ':' + m;
        
        var days = ['So','Mo','Di','Mi','Do','Fr','Sa'];
        return days[date.getDay()] + ', ' + h + ':' + m;
    }
    
    function formatTimeShort(date) {
        var h = date.getHours();
        var m = String(date.getMinutes()).padStart(2, '0');
        var days = ['So','Mo','Di','Mi','Do','Fr','Sa'];
        return days[date.getDay()] + ', ' + h + ':' + m;
    }
    
    function formatDistance(meters) {
        if (meters < 1000) return meters + 'm von hier';
        return (meters/1000).toFixed(1) + 'km von hier';
    }
    
    function openSheet(event, distance) {
        currentEvent = event;
        currentEvent.distance = distance;
        currentVenue = null;
        
        // Build nearby events for swipe navigation
        buildNearbyEvents(event);
        
        // Center map on event - position pin in upper third (above overlay)
        if (map) {
            var mapContainer = document.getElementById('map');
            var mapHeight = mapContainer.offsetHeight;
            // Move pin to upper third: pan map DOWN so pin appears higher
            var offsetY = mapHeight * 0.3;
            
            map.setView([event.lat, event.lng], map.getZoom(), { animate: true });
            setTimeout(function() {
                if (map) map.panBy([0, -offsetY], { animate: true });
            }, 150);
        }
        
        // Highlight the active marker with orange outline
        highlightActiveMarker(event);
        
        openSheetContent(event, distance);
        
        document.getElementById('backdrop').classList.add('visible');
        document.getElementById('eventSheet').classList.add('visible');
    }
    
    function openSheetLaufend(event, distance) {
        currentEvent = event;
        currentEvent.distance = distance;
        currentVenue = null;
        
        // Center map on event - position pin in upper third
        if (map) {
            var mapContainer = document.getElementById('map');
            var mapHeight = mapContainer.offsetHeight;
            var offsetY = mapHeight * 0.3;
            
            map.setView([event.lat, event.lng], map.getZoom(), { animate: true });
            setTimeout(function() {
                if (map) map.panBy([0, -offsetY], { animate: true });
            }, 150);
        }
        
        highlightActiveMarker(event);
        
        // Format end date for Laufend events
        var data = CLUSTERS[event.cluster] || { icon: 'museum', name: 'Ausstellung' };
        document.getElementById('sheetTitle').textContent = event.title;
        
        var months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
        var timeText = event.type;
        if (event.endDate) {
            timeText += ' · bis ' + event.endDate.getDate() + '. ' + months[event.endDate.getMonth()];
        }
        document.getElementById('sheetTime').textContent = timeText;
        document.getElementById('sheetCategory').innerHTML = '<span class="material-symbols-rounded" style="font-size:14px;vertical-align:middle;margin-right:4px;">' + data.icon + '</span>' + data.name;
        document.getElementById('sheetVenue').innerHTML = '<a href="javascript:void(0)" style="cursor:pointer" onclick="openVenueDetail(\'' + event.venueSlug + '\', \'' + event.venue.replace(/'/g, "\\'") + '\')">' + event.venue + '</a>';
        document.getElementById('sheetDistance').textContent = formatDistance(distance);
        
        document.getElementById('backdrop').classList.add('visible');
        document.getElementById('eventSheet').classList.add('visible');
    }
    
    function highlightActiveMarker(event) {
        // Remove previous highlights
        var allMarkers = document.querySelectorAll('.event-marker');
        allMarkers.forEach(function(m) {
            m.classList.remove('active');
        });
        
        // Find marker by event id and add active class
        var markerEl = document.querySelector('[data-event-id="' + event.id + '"]');
        if (markerEl) {
            markerEl.classList.add('active');
        }
    }
    
    function openSheetContent(event, distance) {
        currentEvent = event;
        currentEvent.distance = distance;
        
        var data = CLUSTERS[event.cluster] || CLUSTERS_HEUTE[event.cluster] || { icon: 'event', name: 'Event' };
        document.getElementById('sheetTitle').textContent = event.title;
        document.getElementById('sheetTime').textContent = formatTime(event.datetime);
        document.getElementById('sheetCategory').innerHTML = '<span class="material-symbols-rounded" style="font-size:14px;vertical-align:middle;margin-right:4px;">' + data.icon + '</span>' + data.name;
        document.getElementById('sheetVenue').innerHTML = '<a href="javascript:void(0)" style="cursor:pointer" onclick="openVenueDetail(\'' + event.venueSlug + '\', \'' + event.venue.replace(/'/g, "\\'") + '\')">' + event.venue + '</a>';
        document.getElementById('sheetDistance').textContent = formatDistance(distance);
        
        // Reset action buttons
        var saveBtn = document.getElementById('saveBtn');
        var reminderBtn = document.getElementById('reminderBtn');
        
        if (savedEvents.indexOf(event.id) !== -1) {
            saveBtn.classList.add('saved');
            saveBtn.querySelector('.material-symbols-rounded').textContent = 'bookmark_added';
        } else {
            saveBtn.classList.remove('saved');
            saveBtn.querySelector('.material-symbols-rounded').textContent = 'bookmark';
        }
        
        reminderBtn.classList.remove('saved');
        reminderBtn.querySelector('.material-symbols-rounded').textContent = 'notifications';
    }
    
    // Venue sheet for "Orte" mode
    var currentVenue = null;
    
    function openVenueSheet(venue, distance) {
        currentVenue = venue;
        currentEvent = null;
        
        // Center map on venue - position pin in upper third
        if (map) {
            var mapContainer = document.getElementById('map');
            var mapHeight = mapContainer.offsetHeight;
            var offsetY = mapHeight * 0.3;
            
            map.setView([venue.lat, venue.lng], map.getZoom(), { animate: true });
            setTimeout(function() {
                if (map) map.panBy([0, -offsetY], { animate: true });
            }, 150);
        }
        
        // Update sheet content for venue
        var categoryIcon = 'location_on';
        var categoryName = 'Ort';
        
        // Map venue category to display
        var catMap = {
            'KULT': { icon: 'museum', name: 'Museum' },
            'MUS': { icon: 'theater_comedy', name: 'Bühne' },
            'MICE': { icon: 'location_city', name: 'Zentrum' },
            'WORT': { icon: 'theater_comedy', name: 'Bühne' },
            'GAST': { icon: 'restaurant', name: 'Gastronomie' },
            'SPORT': { icon: 'sports', name: 'Sport' },
            'FAM': { icon: 'family_restroom', name: 'Familie' },
            'EDU': { icon: 'school', name: 'Bildung' }
        };
        if (catMap[venue.category]) {
            categoryIcon = catMap[venue.category].icon;
            categoryName = catMap[venue.category].name;
        }
        
        document.getElementById('sheetTitle').textContent = venue.name;
        document.getElementById('sheetTime').textContent = venue.address || '';
        document.getElementById('sheetCategory').innerHTML = '<span class="material-symbols-rounded" style="font-size:14px;vertical-align:middle;margin-right:4px;">' + categoryIcon + '</span>' + categoryName;
        document.getElementById('sheetVenue').innerHTML = venue.region + ', ' + venue.country;
        document.getElementById('sheetDistance').textContent = formatDistance(distance);
        
        // Reset action buttons
        var saveBtn = document.getElementById('saveBtn');
        var reminderBtn = document.getElementById('reminderBtn');
        saveBtn.classList.remove('saved');
        saveBtn.querySelector('.material-symbols-rounded').textContent = 'bookmark';
        reminderBtn.classList.remove('saved');
        reminderBtn.querySelector('.material-symbols-rounded').textContent = 'notifications';
        
        document.getElementById('backdrop').classList.add('visible');
        document.getElementById('eventSheet').classList.add('visible');
    }
    
    function closeSheet() {
        var sheet = document.getElementById('eventSheet');
        sheet.classList.remove('visible', 'swiping', 'swipe-left', 'swipe-right');
        sheet.style.transform = '';
        document.getElementById('backdrop').classList.remove('visible');
        document.getElementById('shareMenu').classList.remove('visible');
        document.getElementById('reminderMenu').classList.remove('visible');
        currentEvent = null;
        isSwiping = false;
    }
    
    function goToEvent() {
        if (currentEvent) {
            window.open('https://maps.apple.com/?daddr=' + currentEvent.lat + ',' + currentEvent.lng, '_blank');
            closeSheet();
            showToast('Navigation geöffnet.\n\nViel Spaß!');
        } else if (currentVenue) {
            window.open('https://maps.apple.com/?daddr=' + currentVenue.lat + ',' + currentVenue.lng, '_blank');
            closeSheet();
            showToast('Navigation geöffnet.\n\nViel Spaß!');
        }
    }
    
    function openEventDetails() {
        if (currentEvent) {
            // Open venue detail page for the event's venue
            openVenueDetail(currentEvent.venueSlug, currentEvent.venue);
        } else if (currentVenue) {
            // Open venue detail page for the venue
            openVenueDetail(currentVenue.slug, currentVenue.name);
        }
    }
    
    function showToast(msg) {
        var toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('visible');
        setTimeout(function() { toast.classList.remove('visible'); }, 3000);
    }
    
    // Saved events (in-memory for prototype)
    var savedEvents = [];
    
    function toggleSave() {
        if (!currentEvent) return;
        var btn = document.getElementById('saveBtn');
        var idx = savedEvents.indexOf(currentEvent.id);
        
        if (idx === -1) {
            savedEvents.push(currentEvent.id);
            btn.classList.add('saved');
            btn.querySelector('.material-symbols-rounded').textContent = 'bookmark_added';
            showToast('Event gemerkt!');
        } else {
            savedEvents.splice(idx, 1);
            btn.classList.remove('saved');
            btn.querySelector('.material-symbols-rounded').textContent = 'bookmark';
            showToast('Event entfernt');
        }
        updateBookmarksBadge();
    }
    
    function getShareText() {
        if (!currentEvent) return '';
        return currentEvent.title + '\n' + 
               formatTime(currentEvent.datetime) + '\n' + 
               currentEvent.venue + '\n' +
               formatDistance(currentEvent.distance) + '\n\n' +
               '→ SEENÄHE';
    }
    
    function shareWhatsApp() {
        var text = encodeURIComponent(getShareText());
        window.open('https://wa.me/?text=' + text, '_blank');
        document.getElementById('shareMenu').classList.remove('visible');
        showToast('WhatsApp geöffnet');
    }
    
    function shareSignal() {
        var text = encodeURIComponent(getShareText());
        // Signal doesn't have a direct web share URL, use system share or copy
        if (navigator.share) {
            navigator.share({
                title: currentEvent.title,
                text: getShareText()
            }).catch(function() {});
        } else {
            // Copy to clipboard as fallback
            navigator.clipboard.writeText(getShareText()).then(function() {
                showToast('In Zwischenablage kopiert.\nJetzt in Signal einfügen.');
            });
        }
        document.getElementById('shareMenu').classList.remove('visible');
    }
    
    function setReminder(type) {
        document.getElementById('reminderMenu').classList.remove('visible');
        
        if (type === 'day') {
            showToast('Erinnerung gesetzt!\nEinen Tag vorher.');
        } else {
            showToast('Erinnerung gesetzt!\nEine Stunde vorher.');
        }
        
        // Update button to show reminder is set
        var btn = document.getElementById('reminderBtn');
        btn.classList.add('saved');
        btn.querySelector('.material-symbols-rounded').textContent = 'notifications_active';
    }
    
    function setNavMode(mode) {
        currentNav = mode;
        
        // Update tabbar
        var tabs = document.querySelectorAll('.tab-item');
        tabs.forEach(function(tab) { tab.classList.remove('active'); });
        
        if (mode === 'jetzt') {
            document.getElementById('tabHeute').classList.add('active');
            CLUSTERS = CLUSTERS_HEUTE;
        } else if (mode === 'laeuft') {
            document.getElementById('tabLaufend').classList.add('active');
            CLUSTERS = CLUSTERS_LAUFEND;
        } else if (mode === 'orte') {
            document.getElementById('tabOrte').classList.add('active');
            CLUSTERS = CLUSTERS_ORTE;
        } else if (mode === 'gemerkt') {
            document.getElementById('tabGemerkt').classList.add('active');
            // Show bookmarks in list view
            setView('list');
            renderBookmarksList();
            return;
        }
        
        // Clear active filters and rebuild pills
        activeFilters = [];
        buildClusterPills();
        
        // Scroll pills to start
        var pillsContainer = document.getElementById('clusterPills');
        if (pillsContainer) {
            pillsContainer.scrollLeft = 0;
        }
        
        // Update markers based on mode
        updateMarkers();
        if (currentView === 'list') {
            renderList();
        }
    }
    
    function renderBookmarksList() {
        var listContent = document.getElementById('listContent');
        listContent.innerHTML = '';
        
        document.getElementById('listCount').textContent = savedEvents.length + ' Gemerkt';
        
        if (savedEvents.length === 0) {
            listContent.innerHTML = '<div style="padding: 60px 24px; text-align: center; color: var(--text-secondary);"><span class="material-symbols-rounded" style="font-size: 48px; display: block; margin-bottom: 16px;">bookmark_border</span>Noch keine Events gemerkt.<br>Tippe auf das Lesezeichen-Icon,<br>um Events zu speichern.</div>';
            return;
        }
        
        var monthNames = ['JAN', 'FEB', 'MÄR', 'APR', 'MAI', 'JUN', 'JUL', 'AUG', 'SEP', 'OKT', 'NOV', 'DEZ'];
        var weekdayNames = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
        
        for (var i = 0; i < savedEvents.length; i++) {
            var eventId = savedEvents[i];
            var event = EVENTS.find(function(e) { return e.id === eventId; });
            if (!event) continue;
            
            var distance = calcDistance(userLat, userLng, event.lat, event.lng);
            var data = CLUSTERS_HEUTE[event.cluster] || { icon: 'event', name: 'Event' };
            
            var dayNum = event.datetime.getDate();
            var monthAbbr = monthNames[event.datetime.getMonth()];
            var weekdayAbbr = weekdayNames[event.datetime.getDay()];
            var h = event.datetime.getHours();
            var m = String(event.datetime.getMinutes()).padStart(2, '0');
            var timeStr = h + ':' + m;
            
            var listItem = document.createElement('div');
            listItem.className = 'list-item';
            listItem.innerHTML = 
                '<div class="list-date-box"><span class="list-date-weekday">' + weekdayAbbr + '</span><span class="list-date-day">' + dayNum + '</span><span class="list-date-month">' + monthAbbr + '</span></div>' +
                '<div class="list-content">' +
                    '<div class="list-title">' + event.title + '</div>' +
                    '<div class="list-venue">' + event.venue + '</div>' +
                    '<div class="list-category"><span class="material-symbols-rounded">' + data.icon + '</span>' + data.name + '</div>' +
                '</div>' +
                '<div class="list-time">' + timeStr + '</div>';
            
            (function(ev, dist) {
                listItem.onclick = function() { 
                    currentNav = 'jetzt';
                    CLUSTERS = CLUSTERS_HEUTE;
                    openSheet(ev, dist); 
                };
            })(event, distance);
            
            listContent.appendChild(listItem);
        }
    }
    
    function handleSwipeStart(e) {
        swipeStartX = e.touches[0].clientX;
        swipeCurrentX = swipeStartX;
        isSwiping = true;
        document.getElementById('eventSheet').classList.add('swiping');
    }
    
    function handleSwipeMove(e) {
        if (!isSwiping) return;
        swipeCurrentX = e.touches[0].clientX;
        var diff = swipeCurrentX - swipeStartX;
        
        // Only allow horizontal swipe
        if (Math.abs(diff) > 10) {
            e.preventDefault();
            var sheet = document.getElementById('eventSheet');
            sheet.style.transform = 'translateX(' + diff + 'px)';
        }
    }
    
    function handleSwipeEnd(e) {
        if (!isSwiping) return;
        isSwiping = false;
        
        var sheet = document.getElementById('eventSheet');
        sheet.classList.remove('swiping');
        
        var diff = swipeCurrentX - swipeStartX;
        var threshold = 80;
        
        if (diff > threshold && currentEventIndex > 0) {
            // Swipe right - previous event
            sheet.classList.add('swipe-right');
            setTimeout(function() {
                currentEventIndex--;
                showEventAtIndex(currentEventIndex);
                sheet.classList.remove('swipe-right');
            }, 300);
        } else if (diff < -threshold && currentEventIndex < nearbyEvents.length - 1) {
            // Swipe left - next event
            sheet.classList.add('swipe-left');
            setTimeout(function() {
                currentEventIndex++;
                showEventAtIndex(currentEventIndex);
                sheet.classList.remove('swipe-left');
            }, 300);
        } else {
            // Reset position
            sheet.style.transform = 'translateY(0)';
        }
    }
    
    function showEventAtIndex(index) {
        if (index < 0 || index >= nearbyEvents.length) return;
        
        var item = nearbyEvents[index];
        var sheet = document.getElementById('eventSheet');
        sheet.style.transform = '';
        
        // Update active marker
        highlightMarker(item.event);
        
        // Center map on event
        map.panTo([item.event.lat, item.event.lng], { animate: true });
        
        // Update sheet content
        openSheetContent(item.event, item.distance);
    }
    
    function highlightMarker(event) {
        // Remove previous highlight
        if (activeMarkerElement) {
            activeMarkerElement.classList.remove('active');
        }
        
        // Find and highlight new marker
        var markers = document.querySelectorAll('.event-marker');
        markers.forEach(function(m) {
            m.classList.remove('active');
        });
        
        // The marker for this event - we'll add the class via the marker reference
        // For now, we highlight by adding class to all markers at this location (simplified)
    }
    
    function buildNearbyEvents(centerEvent) {
        nearbyEvents = [];
        
        for (var i = 0; i < EVENTS.length; i++) {
            var event = EVENTS[i];
            
            // Filter check
            if (activeFilters.length > 0 && activeFilters.indexOf(event.cluster) === -1) {
                continue;
            }
            
            // Navigation mode filter
            var hours = (event.datetime - new Date()) / 3600000;
            if (currentNav === 'jetzt' && hours > 48) continue;
            if (currentNav === 'laeuft' && (hours < 0 || hours > 24 * 90)) continue;
            
            var distance = calcDistance(centerEvent.lat, centerEvent.lng, event.lat, event.lng);
            nearbyEvents.push({ event: event, distance: distance, distFromUser: calcDistance(userLat, userLng, event.lat, event.lng) });
        }
        
        // Sort by distance from center event (geographic proximity)
        nearbyEvents.sort(function(a, b) {
            return a.distance - b.distance;
        });
        
        // Find index of center event
        for (var j = 0; j < nearbyEvents.length; j++) {
            if (nearbyEvents[j].event.id === centerEvent.id) {
                currentEventIndex = j;
                break;
            }
        }
    }
    
    function setView(view) {
        currentView = view;
        
        var toggle = document.getElementById('viewToggle');
        var mapToggle = document.getElementById('toggleMap');
        var listToggle = document.getElementById('toggleList');
        var listView = document.getElementById('listView');
        var mapEl = document.getElementById('map');
        
        if (view === 'map') {
            toggle.classList.remove('list-active');
            mapToggle.classList.add('active');
            listToggle.classList.remove('active');
            listView.classList.remove('visible');
            mapEl.style.visibility = 'visible';
            if (map) map.invalidateSize();
        } else {
            toggle.classList.add('list-active');
            mapToggle.classList.remove('active');
            listToggle.classList.add('active');
            listView.classList.add('visible');
            mapEl.style.visibility = 'hidden';
            renderList();
        }
    }
    
    function renderList() {
        var listContent = document.getElementById('listContent');
        listContent.innerHTML = '';
        
        var eventsWithDist = [];
        var sourceEvents = currentNav === 'laeuft' ? EVENTS_LAUFEND : EVENTS;
        
        // For Orte mode, show venues instead
        if (currentNav === 'orte') {
            var venueCategoryMap = {
                'KULT': 'museen', 'MUS': 'buehnen', 'MICE': 'zentren',
                'WORT': 'buehnen', 'GAST': 'zentren', 'SPORT': 'sport',
                'FAM': 'zentren', 'EDU': 'museen'
            };
            
            for (var v = 0; v < VENUES.length; v++) {
                var venue = VENUES[v];
                var venueFilter = venueCategoryMap[venue.category] || 'zentren';
                
                if (activeFilters.length > 0 && activeFilters.indexOf(venueFilter) === -1) {
                    continue;
                }
                
                var distance = calcDistance(userLat, userLng, venue.lat, venue.lng);
                eventsWithDist.push({ venue: venue, distance: distance, filter: venueFilter });
            }
            
            eventsWithDist.sort(function(a, b) { return a.distance - b.distance; });
            
            var prefix = activeFilters.length === 0 ? 'Alle ' : '';
            document.getElementById('listCount').textContent = prefix + eventsWithDist.length + ' Orte';
            
            for (var j = 0; j < eventsWithDist.length; j++) {
                var item = eventsWithDist[j];
                var venue = item.venue;
                var data = CLUSTERS[item.filter] || { icon: 'location_on', name: 'Ort' };
                
                var listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.innerHTML = 
                    '<div class="list-date-box" style="background:var(--text-secondary);"><span class="material-symbols-rounded" style="font-size:28px;">' + data.icon + '</span></div>' +
                    '<div class="list-content">' +
                        '<div class="list-title">' + venue.name + '</div>' +
                        '<div class="list-venue">' + venue.region + ', ' + venue.country + '</div>' +
                        '<div class="list-category"><span class="material-symbols-rounded">' + data.icon + '</span>' + data.name + '</div>' +
                    '</div>' +
                    '<div class="list-time" style="font-size:14px;">' + (item.distance / 1000).toFixed(1) + ' km</div>';
                
                (function(ven, dist) {
                    listItem.onclick = function() { openVenueSheet(ven, dist); };
                })(venue, item.distance);
                
                listContent.appendChild(listItem);
            }
            return;
        }
        
        // Events mode (Heute or Laufend)
        for (var i = 0; i < sourceEvents.length; i++) {
            var event = sourceEvents[i];
            
            if (activeFilters.length > 0 && activeFilters.indexOf(event.cluster) === -1) {
                continue;
            }
            
            if (!CLUSTERS[event.cluster]) {
                continue;
            }
            
            var distance = calcDistance(userLat, userLng, event.lat, event.lng);
            eventsWithDist.push({ event: event, distance: distance });
        }
        
        // Sort
        if (currentNav === 'laeuft') {
            // Sort Laufend by end date
            eventsWithDist.sort(function(a, b) {
                if (!a.event.endDate) return 1;
                if (!b.event.endDate) return -1;
                return a.event.endDate - b.event.endDate;
            });
        } else {
            eventsWithDist.sort(function(a, b) {
                var dateA = a.event.datetime.toDateString();
                var dateB = b.event.datetime.toDateString();
                if (dateA !== dateB) {
                    return a.event.datetime - b.event.datetime;
                }
                if (currentSort === 'distance') {
                    return a.distance - b.distance;
                }
                return a.event.datetime - b.event.datetime;
            });
        }
        
        var prefix = activeFilters.length === 0 ? 'Alle ' : '';
        var countLabel = currentNav === 'laeuft' ? ' Ausstellungen' : ' Events';
        document.getElementById('listCount').textContent = prefix + eventsWithDist.length + countLabel;
        
        var monthNames = ['JAN', 'FEB', 'MÄR', 'APR', 'MAI', 'JUN', 'JUL', 'AUG', 'SEP', 'OKT', 'NOV', 'DEZ'];
        var weekdayNames = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
        var currentDateGroup = null;
        
        for (var j = 0; j < eventsWithDist.length; j++) {
            var item = eventsWithDist[j];
            var event = item.event;
            var distance = item.distance;
            var data = CLUSTERS[event.cluster] || CLUSTERS_HEUTE[event.cluster] || { icon: 'event', name: 'Event' };
            
            var listItem = document.createElement('div');
            listItem.className = 'list-item';
            
            if (currentNav === 'laeuft') {
                // Laufend mode - show exhibition info
                var endText = event.endDate ? 
                    'bis ' + event.endDate.getDate() + '. ' + monthNames[event.endDate.getMonth()] : 
                    'Dauerhaft';
                
                listItem.innerHTML = 
                    '<div class="list-date-box"><span class="material-symbols-rounded" style="font-size:28px;">museum</span></div>' +
                    '<div class="list-content">' +
                        '<div class="list-title">' + event.title + '</div>' +
                        '<div class="list-venue">' + event.venue + '</div>' +
                        '<div class="list-category"><span class="material-symbols-rounded">' + data.icon + '</span>' + event.type + '</div>' +
                    '</div>' +
                    '<div class="list-time" style="font-size:12px;font-weight:400;">' + endText + '</div>';
                
                (function(ev, dist) {
                    listItem.onclick = function() { openSheetLaufend(ev, dist); };
                })(event, distance);
            } else {
                // Heute mode
                var dayNum = event.datetime.getDate();
                var monthAbbr = monthNames[event.datetime.getMonth()];
                var weekdayAbbr = weekdayNames[event.datetime.getDay()];
                var dateKey = event.datetime.toDateString();
                
                if (dateKey !== currentDateGroup) {
                    currentDateGroup = dateKey;
                    var dateHeader = document.createElement('div');
                    dateHeader.className = 'list-date-header';
                    dateHeader.textContent = getDateLabel(event.datetime);
                    listContent.appendChild(dateHeader);
                }
                
                var h = event.datetime.getHours();
                var m = String(event.datetime.getMinutes()).padStart(2, '0');
                var timeStr = h + ':' + m;
                
                listItem.innerHTML = 
                    '<div class="list-date-box"><span class="list-date-weekday">' + weekdayAbbr + '</span><span class="list-date-day">' + dayNum + '</span><span class="list-date-month">' + monthAbbr + '</span></div>' +
                    '<div class="list-content">' +
                        '<div class="list-title">' + event.title + '</div>' +
                        '<div class="list-venue">' + event.venue + '</div>' +
                        '<div class="list-category"><span class="material-symbols-rounded">' + data.icon + '</span>' + data.name + '</div>' +
                    '</div>' +
                    '<div class="list-time">' + timeStr + '</div>';
                
                (function(ev, dist) {
                    listItem.onclick = function() { openSheet(ev, dist); };
                })(event, distance);
            }
            
            listContent.appendChild(listItem);
        }
        
        function getDateLabel(date) {
            var today = new Date();
            var tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            var eventDate = new Date(date);
            eventDate.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            tomorrow.setHours(0,0,0,0);
            
            if (eventDate.getTime() === today.getTime()) {
                return 'Heute';
            } else if (eventDate.getTime() === tomorrow.getTime()) {
                return 'Morgen';
            } else {
                var weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
                var months = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                return weekdays[date.getDay()] + ', ' + date.getDate() + '. ' + months[date.getMonth()];
            }
        }
    }
    
    function formatDistanceShort(meters) {
        if (meters < 1000) {
            return '<span class="list-distance-value">' + meters + '</span><span class="list-distance-unit">m</span>';
        }
        return '<span class="list-distance-value">' + (meters/1000).toFixed(1) + '</span><span class="list-distance-unit">km</span>';
    }
    
    function setSort(sort) {
        currentSort = sort;
        
        var distBtn = document.getElementById('sortDistance');
        var dateBtn = document.getElementById('sortDate');
        var sortLabel = document.getElementById('sortLabel');
        
        if (sort === 'distance') {
            distBtn.classList.add('active');
            dateBtn.classList.remove('active');
            sortLabel.textContent = 'Nähe';
        } else {
            distBtn.classList.remove('active');
            dateBtn.classList.add('active');
            sortLabel.textContent = 'Datum';
        }
        
        document.getElementById('sortMenu').classList.remove('visible');
        renderList();
    }
    
    function openBookmarks() {
        renderBookmarks();
        document.getElementById('bookmarksView').classList.add('visible');
    }
    
    function closeBookmarks() {
        document.getElementById('bookmarksView').classList.remove('visible');
    }
    
    function renderBookmarks() {
        var list = document.getElementById('bookmarksList');
        list.innerHTML = '';
        
        if (savedEvents.length === 0) {
            list.innerHTML = '<div class="bookmarks-empty">Noch keine Events gemerkt.<br><br>Tippe auf das Lesezeichen-Symbol bei einem Event, um es hier zu speichern.</div>';
            return;
        }
        
        for (var i = 0; i < savedEvents.length; i++) {
            var eventId = savedEvents[i];
            var event = null;
            
            // Find event by ID
            for (var j = 0; j < EVENTS.length; j++) {
                if (EVENTS[j].id === eventId) {
                    event = EVENTS[j];
                    break;
                }
            }
            
            if (!event) continue;
            
            var distance = calcDistance(userLat, userLng, event.lat, event.lng);
            var data = CLUSTERS[event.cluster];
            var dayNum = event.datetime.getDate();
            var monthNames = ['JAN', 'FEB', 'MÄR', 'APR', 'MAI', 'JUN', 'JUL', 'AUG', 'SEP', 'OKT', 'NOV', 'DEZ'];
            var weekdayNames = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
            var monthAbbr = monthNames[event.datetime.getMonth()];
            var weekdayAbbr = weekdayNames[event.datetime.getDay()];
            
            var listItem = document.createElement('div');
            listItem.className = 'list-item';
            listItem.innerHTML = 
                '<div class="list-date-box"><span class="list-date-weekday">' + weekdayAbbr + '</span><span class="list-date-day">' + dayNum + '</span><span class="list-date-month">' + monthAbbr + '</span></div>' +
                '<div class="list-content">' +
                    '<div class="list-title">' + event.title + '</div>' +
                    '<div class="list-meta"><div class="list-meta-venue">' + event.venue + '</div><div class="list-meta-time">' + formatTimeShort(event.datetime) + '</div></div>' +
                    '<div class="list-category"><span class="material-symbols-rounded">' + data.icon + '</span>' + data.name + '</div>' +
                '</div>' +
                '<div class="list-distance">' + formatDistanceShort(distance) + '</div>';
            
            (function(ev, dist) {
                listItem.onclick = function() {
                    closeBookmarks();
                    setTimeout(function() {
                        openSheet(ev, dist);
                    }, 300);
                };
            })(event, distance);
            
            list.appendChild(listItem);
        }
    }
    
    function updateBookmarksBadge() {
        var badge = document.getElementById('tabBadge');
        if (badge) {
            if (savedEvents.length > 0) {
                badge.textContent = savedEvents.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
    }
    
    function getVenueHours(slug) {
        // Different opening hours based on venue type
        var venueHours = {
            // Museums - typically closed Mondays
            'kunstmuseum-ravensburg': { mon: 'Geschlossen', tue: '11:00 – 18:00', wed: '11:00 – 18:00', thu: '11:00 – 20:00', fri: '11:00 – 18:00', sat: '11:00 – 18:00', sun: '11:00 – 18:00' },
            'zeppelin-museum': { mon: 'Geschlossen', tue: '10:00 – 17:00', wed: '10:00 – 17:00', thu: '10:00 – 17:00', fri: '10:00 – 17:00', sat: '10:00 – 17:00', sun: '10:00 – 17:00' },
            'dornier-museum': { mon: '10:00 – 17:00', tue: '10:00 – 17:00', wed: '10:00 – 17:00', thu: '10:00 – 17:00', fri: '10:00 – 17:00', sat: '10:00 – 18:00', sun: '10:00 – 18:00' },
            'kunsthaus-bregenz': { mon: 'Geschlossen', tue: '10:00 – 18:00', wed: '10:00 – 18:00', thu: '10:00 – 21:00', fri: '10:00 – 18:00', sat: '10:00 – 18:00', sun: '10:00 – 18:00' },
            
            // Theaters - evening hours
            'theater-ravensburg': { mon: 'Geschlossen', tue: '17:00 – 22:00', wed: '17:00 – 22:00', thu: '17:00 – 22:00', fri: '17:00 – 23:00', sat: '15:00 – 23:00', sun: '14:00 – 20:00' },
            'stadttheater-konstanz': { mon: 'Geschlossen', tue: '18:00 – 22:00', wed: '18:00 – 22:00', thu: '18:00 – 22:00', fri: '18:00 – 23:00', sat: '16:00 – 23:00', sun: '15:00 – 21:00' },
            'stadttheater-lindau': { mon: 'Geschlossen', tue: '18:00 – 22:00', wed: '18:00 – 22:00', thu: '18:00 – 22:00', fri: '18:00 – 23:00', sat: '17:00 – 23:00', sun: '16:00 – 21:00' },
            
            // Concert halls
            'konzerthaus-ravensburg': { mon: 'Geschlossen', tue: '10:00 – 18:00', wed: '10:00 – 18:00', thu: '10:00 – 21:00', fri: '10:00 – 22:00', sat: '10:00 – 22:00', sun: '10:00 – 18:00' },
            'graf-zeppelin-haus': { mon: '09:00 – 18:00', tue: '09:00 – 18:00', wed: '09:00 – 18:00', thu: '09:00 – 21:00', fri: '09:00 – 22:00', sat: '10:00 – 22:00', sun: '10:00 – 18:00' },
            'inselhalle-lindau': { mon: '09:00 – 17:00', tue: '09:00 – 17:00', wed: '09:00 – 17:00', thu: '09:00 – 21:00', fri: '09:00 – 22:00', sat: '10:00 – 22:00', sun: '10:00 – 17:00' },
            
            // Cultural centers
            'kulturhaus-ravensburg': { mon: '10:00 – 18:00', tue: '10:00 – 18:00', wed: '10:00 – 18:00', thu: '10:00 – 21:00', fri: '10:00 – 22:00', sat: '10:00 – 22:00', sun: '12:00 – 18:00' },
            'zehntscheuer-ravensburg': { mon: 'Geschlossen', tue: '14:00 – 22:00', wed: '14:00 – 22:00', thu: '14:00 – 22:00', fri: '14:00 – 23:00', sat: '11:00 – 23:00', sun: '11:00 – 20:00' },
            'kulturzentrum-konstanz': { mon: '10:00 – 18:00', tue: '10:00 – 18:00', wed: '10:00 – 18:00', thu: '10:00 – 21:00', fri: '10:00 – 22:00', sat: '10:00 – 22:00', sun: '12:00 – 18:00' },
            
            // Castles & historical sites
            'schloss-meersburg': { mon: '10:00 – 18:00', tue: '10:00 – 18:00', wed: '10:00 – 18:00', thu: '10:00 – 18:00', fri: '10:00 – 18:00', sat: '10:00 – 18:00', sun: '10:00 – 18:00' },
            'schloss-tettnang': { mon: 'Geschlossen', tue: '10:00 – 17:00', wed: '10:00 – 17:00', thu: '10:00 – 17:00', fri: '10:00 – 17:00', sat: '10:00 – 17:00', sun: '10:00 – 17:00' },
            'kloster-salem': { mon: '10:00 – 17:00', tue: '10:00 – 17:00', wed: '10:00 – 17:00', thu: '10:00 – 17:00', fri: '10:00 – 17:00', sat: '10:00 – 18:00', sun: '10:00 – 18:00' },
            'kloster-weingarten': { mon: '10:00 – 17:00', tue: '10:00 – 17:00', wed: '10:00 – 17:00', thu: '10:00 – 17:00', fri: '10:00 – 17:00', sat: '10:00 – 17:00', sun: '12:00 – 17:00' },
            
            // Open air venues
            'seebuehne-bregenz': { mon: 'Je nach Veranstaltung', tue: 'Je nach Veranstaltung', wed: 'Je nach Veranstaltung', thu: 'Je nach Veranstaltung', fri: 'Je nach Veranstaltung', sat: 'Je nach Veranstaltung', sun: 'Je nach Veranstaltung' },
            'insel-mainau': { mon: '09:00 – 19:00', tue: '09:00 – 19:00', wed: '09:00 – 19:00', thu: '09:00 – 19:00', fri: '09:00 – 19:00', sat: '09:00 – 19:00', sun: '09:00 – 19:00' },
            
            // City halls
            'stadthalle-wangen': { mon: '09:00 – 17:00', tue: '09:00 – 17:00', wed: '09:00 – 17:00', thu: '09:00 – 20:00', fri: '09:00 – 21:00', sat: '10:00 – 21:00', sun: 'Geschlossen' }
        };
        
        // Return specific hours or default
        return venueHours[slug] || {
            mon: '10:00 – 18:00',
            tue: '10:00 – 18:00',
            wed: '10:00 – 18:00',
            thu: '10:00 – 20:00',
            fri: '10:00 – 18:00',
            sat: '10:00 – 18:00',
            sun: '11:00 – 17:00'
        };
    }
    
    function openVenueDetail(slug, name) {
        // Find venue by slug
        var venue = null;
        for (var i = 0; i < VENUES.length; i++) {
            if (VENUES[i].slug === slug) {
                venue = VENUES[i];
                break;
            }
        }
        
        if (!venue) return;
        
        // Close event sheet first
        closeSheet();
        
        // Populate venue detail
        document.getElementById('venueName').textContent = venue.name;
        document.getElementById('venueType').textContent = 'Kulturstätte · Bodenseeregion';
        document.getElementById('venueDescription').textContent = 'Ein einzigartiger Ort für Kultur und Begegnung am Bodensee. Hier treffen sich Menschen aus der ganzen Region, um gemeinsam Kunst, Musik und Theater zu erleben. Die besondere Atmosphäre macht jeden Besuch zu einem unvergesslichen Erlebnis.';
        document.getElementById('venueAddress').textContent = venue.name + ', Bodensee';
        document.getElementById('venueWebsite').textContent = 'www.' + slug + '.de';
        
        // Initialize carousel
        initVenueCarousel();
        
        // Set opening hours based on venue type
        var hours = getVenueHours(slug);
        document.getElementById('hoursMon').textContent = hours.mon;
        document.getElementById('hoursTue').textContent = hours.tue;
        document.getElementById('hoursWed').textContent = hours.wed;
        document.getElementById('hoursThu').textContent = hours.thu;
        document.getElementById('hoursFri').textContent = hours.fri;
        document.getElementById('hoursSat').textContent = hours.sat;
        document.getElementById('hoursSun').textContent = hours.sun;
        
        // Find events at this venue
        var venueEvents = [];
        for (var j = 0; j < EVENTS.length; j++) {
            if (EVENTS[j].venueSlug === slug) {
                var dist = calcDistance(userLat, userLng, EVENTS[j].lat, EVENTS[j].lng);
                venueEvents.push({ event: EVENTS[j], distance: dist });
            }
        }
        
        // Sort by date
        venueEvents.sort(function(a, b) {
            return a.event.datetime - b.event.datetime;
        });
        
        // Render events list
        var listEl = document.getElementById('venueEventsList');
        listEl.innerHTML = '';
        
        if (venueEvents.length === 0) {
            listEl.innerHTML = '<div style="padding:24px 16px;color:var(--text-secondary);text-align:center;">Keine weiteren Events an diesem Ort.</div>';
        } else {
            var monthNames = ['JAN', 'FEB', 'MÄR', 'APR', 'MAI', 'JUN', 'JUL', 'AUG', 'SEP', 'OKT', 'NOV', 'DEZ'];
            var weekdayNames = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
            
            for (var k = 0; k < venueEvents.length; k++) {
                var item = venueEvents[k];
                var event = item.event;
                var data = CLUSTERS[event.cluster] || CLUSTERS_HEUTE[event.cluster] || { icon: 'event', name: 'Event' };
                var dayNum = event.datetime.getDate();
                var monthAbbr = monthNames[event.datetime.getMonth()];
                var weekdayAbbr = weekdayNames[event.datetime.getDay()];
                var h = event.datetime.getHours();
                var m = String(event.datetime.getMinutes()).padStart(2, '0');
                var timeStr = h + ':' + m;
                
                var listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.innerHTML = 
                    '<div class="list-date-box"><span class="list-date-weekday">' + weekdayAbbr + '</span><span class="list-date-day">' + dayNum + '</span><span class="list-date-month">' + monthAbbr + '</span></div>' +
                    '<div class="list-content">' +
                        '<div class="list-title">' + event.title + '</div>' +
                        '<div class="list-category"><span class="material-symbols-rounded">' + data.icon + '</span>' + data.name + '</div>' +
                    '</div>' +
                    '<div class="list-time">' + timeStr + '</div>';
                
                (function(ev, dist) {
                    listItem.onclick = function() {
                        closeVenueDetail();
                        setTimeout(function() {
                            openSheet(ev, dist);
                        }, 300);
                    };
                })(event, item.distance);
                
                listEl.appendChild(listItem);
            }
        }
        
        document.getElementById('venueView').classList.add('visible');
    }
    
    function closeVenueDetail() {
        document.getElementById('venueView').classList.remove('visible');
        // Re-show the event sheet if there was a current event/venue
        if (currentEvent || currentVenue) {
            document.getElementById('backdrop').classList.add('visible');
            document.getElementById('eventSheet').classList.add('visible');
        }
    }
    
    // Venue carousel functionality
    var carouselIndex = 0;
    var carouselStartX = 0;
    var carouselCurrentX = 0;
    var isCarouselSwiping = false;
    
    function initVenueCarousel() {
        carouselIndex = 0;
        updateCarousel();
        
        var track = document.getElementById('venueCarouselTrack');
        track.addEventListener('touchstart', handleCarouselStart, { passive: true });
        track.addEventListener('touchmove', handleCarouselMove, { passive: false });
        track.addEventListener('touchend', handleCarouselEnd, { passive: true });
    }
    
    function handleCarouselStart(e) {
        carouselStartX = e.touches[0].clientX;
        carouselCurrentX = carouselStartX;
        isCarouselSwiping = true;
    }
    
    function handleCarouselMove(e) {
        if (!isCarouselSwiping) return;
        carouselCurrentX = e.touches[0].clientX;
        var diff = carouselCurrentX - carouselStartX;
        var track = document.getElementById('venueCarouselTrack');
        var baseOffset = -carouselIndex * 100;
        var dragOffset = (diff / track.parentElement.offsetWidth) * 100;
        track.style.transform = 'translateX(' + (baseOffset + dragOffset) + '%)';
    }
    
    function handleCarouselEnd(e) {
        if (!isCarouselSwiping) return;
        isCarouselSwiping = false;
        
        var diff = carouselCurrentX - carouselStartX;
        var threshold = 50;
        
        if (diff < -threshold && carouselIndex < 4) {
            carouselIndex++;
        } else if (diff > threshold && carouselIndex > 0) {
            carouselIndex--;
        }
        
        updateCarousel();
    }
    
    function updateCarousel() {
        var track = document.getElementById('venueCarouselTrack');
        track.style.transform = 'translateX(' + (-carouselIndex * 100) + '%)';
        
        var dots = document.querySelectorAll('.venue-carousel-dot');
        dots.forEach(function(dot, i) {
            dot.classList.toggle('active', i === carouselIndex);
        });
    }
    </script>
</body>
</html>
